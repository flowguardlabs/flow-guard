---
title: "VestingCovenant"
description: "Full parameter, function, and state reference for the VestingCovenant contract."
icon: "lock-keyhole"
---

`VestingCovenant` enforces linear or step-based token vesting schedules with cliff, pause/resume, cancel, and recipient transfer.

**Contract path:** `contracts/core/streaming/VestingCovenant.cash`
**CashScript version:** `^0.13.0`

## Constructor Parameters (Bytecode-Embedded)

| Parameter | Type | Description |
|-|-|-|
| `vaultId` | `bytes32` | Links to source vault |
| `senderHash` | `bytes20` | `hash160(sender pubkey)` — controls pause/cancel |
| `scheduleType` | `int` | `1` = LINEAR_VESTING, `2` = STEP_VESTING |
| `totalAmount` | `int` | Total tokens or BCH to vest |
| `startTimestamp` | `int` | When vesting begins (unix seconds) |
| `endTimestamp` | `int` | When fully vested |
| `cliffTimestamp` | `int` | No claims before this time. `0` = no cliff. |
| `stepInterval` | `int` | Seconds per step (STEP_VESTING only, else `0`) |
| `stepAmount` | `int` | Tokens per step (STEP_VESTING only, else `0`) |

## NFT State (40 bytes)

```
[0]:    status         (uint8)
[1]:    flags          (uint8)
[2-9]:  total_released (uint64)
[10-14]: cursor        (5 bytes, unix timestamp, adjusted for pauses)
[15-19]: pause_start   (5 bytes, 0 if not paused)
[20-39]: recipient_hash (bytes20)
```

## Transaction Structure

All entrypoints spend vesting state from `tx.inputs[0]`.

| Function | Required outputs | Notes |
|-|-|-|
| `claim` | `tx.outputs[0]` recipient payout, `tx.outputs[1]` updated vesting UTXO | Claimable amount is computed on-chain. |
| `complete` | No continuation output required | Optional `tx.outputs[0]` payout of remaining amount to recipient. |
| `pause` | `tx.outputs[0]` updated vesting UTXO | Stores pause start timestamp. |
| `resume` | `tx.outputs[0]` updated vesting UTXO | Shifts vesting cursor forward by pause duration. |
| `cancel` | If `claimableNow > 0`: `tx.outputs[0]` recipient payout. If `unvested > 0`: `tx.outputs[1]` sender payout | Cancellation consumes covenant UTXO. |
| `transfer` | `tx.outputs[0]` updated vesting UTXO | Rewrites mutable recipient hash. |

## Functions

### `claim(sig recipientSig, pubkey recipientPubkey)`

Recipient claims all currently vested and unclaimed tokens.

**Validates:** recipient signature, `status == ACTIVE`, cliff passed, `claimable > 0`

**Vested amount:**
- LINEAR: `vestedTotal = (totalAmount × elapsed) / duration`
- STEP: `vestedTotal = (elapsed / stepInterval) × stepAmount`
- `claimable = vestedTotal - total_released`

**Auto-completes** when `newTotalReleased >= totalAmount` → `status = COMPLETED`

### `complete()`

Permissionless. Forces completion after `endTimestamp`. Distributes any remaining unvested/unclaimed amount to recipient.

**Validates:** `tx.locktime >= endTimestamp`

### `pause(sig senderSig, pubkey senderPubkey)`

Sender-only. Requires `FLAG_CANCELABLE`. Records `pause_start = tx.locktime`.

### `resume(sig senderSig, pubkey senderPubkey)`

Sender-only. Advances `cursor` by pause duration: `newCursor = cursor + (tx.locktime - pause_start)`.

### `cancel(sig senderSig, pubkey senderPubkey)`

Sender-only. Requires `FLAG_CANCELABLE`. Splits at cancellation time:
- Vested (unclaimed) → recipient
- Unvested → sender

Output indexing in this version is strict:
- If `claimableNow > 0`, recipient payout is enforced at `tx.outputs[0]`.
- If `unvested > 0`, sender payout is enforced at `tx.outputs[1]`.

### `transfer(sig recipientSig, pubkey recipientPubkey, bytes20 newRecipientHash)`

Recipient-only. Requires `FLAG_TRANSFERABLE` and `status == ACTIVE`. Updates `recipient_hash` in NFT state.

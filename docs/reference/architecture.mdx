---
title: "Architecture"
description: "How all FlowGuard contracts interconnect: system diagram, contract relationships, and the indexer/executor data flow."
icon: "diagram-project"
---

## System Overview

FlowGuard is composed of three layers: on-chain contracts, an off-chain backend (API + indexer + executor), and a frontend app.

```mermaid
flowchart TD
    BCH["BCH Node"] --> IDX
    IDX --> DB
    EXE --> DB
    EXE --> BCH
    API --> DB
    APP --> API
    APP -->|wallet tx| BCH

    VC -->|vaultId| VSC
    VC -->|vaultId| RPC
    VC -->|vaultId| AC
    VC -->|vaultId| GC
    VC -->|vaultId| BC
    VC -->|vaultId| RC
    PC -->|proposalId| VLC
    PC -->|vaultId| VC

    VC["VaultCovenant"]
    PC["ProposalCovenant"]
    VLC["VoteLockCovenant"]
    VSC["VestingCovenant"]
    RPC["RecurringPaymentCovenant"]
    AC["AirdropCovenant"]
    GC["GrantCovenant"]
    BC["BountyCovenant"]
    RC["RewardCovenant"]
    IDX["Indexer"]
    DB[("SQLite DB")]
    API["REST API"]
    EXE["Executor"]
    APP["Frontend App"]

    classDef contract fill:#00C896,stroke:#00A37A,color:#000
    classDef backend fill:#1a2e27,stroke:#00C896,color:#fff
    classDef node fill:#0A0F0D,stroke:#444,color:#ccc

    class VC,PC,VLC,VSC,RPC,AC,GC,BC,RC contract
    class IDX,DB,API,EXE backend
    class BCH,APP node
```

## Contract Dependency Map

```mermaid
flowchart LR
    V[VaultCovenant] -->|spawn| S["Streaming Covenants\nVesting + RecurringPayment"]
    V -->|spawn| D["Distribution Covenants\nAirdrop + Grant + Bounty + Reward"]
    V -->|"linked via vaultId"| P[ProposalCovenant]
    P -->|"spawns per vote"| VL[VoteLockCovenant]
```

## NFT Commitment Sizes

| Contract | Commitment Size |
|-|-|
| VaultCovenant | 32 bytes |
| ProposalCovenant | 40 bytes |
| VestingCovenant | 40 bytes |
| RecurringPaymentCovenant | 40 bytes |
| AirdropCovenant | 40 bytes |
| GrantCovenant | 40 bytes |
| BountyCovenant | 40 bytes |
| RewardCovenant | 40 bytes |
| VoteLockCovenant | 32 bytes |

All commitments are within the CashTokens 40-byte hard limit.

## Indexer Data Flow

```mermaid
sequenceDiagram
    participant BCH as BCH Node
    participant BM as blockchain-monitor
    participant DB as SQLite DB
    participant API as REST API
    participant FE as Frontend

    BCH->>BM: New block notification
    BM->>BCH: Fetch block transactions
    BM->>BM: Parse covenant UTXOs / decode NFT commitments
    BM->>DB: Upsert covenant states + insert transactions
    FE->>API: GET /api/streams
    API->>DB: Query streams table
    API->>FE: Stream records with decoded state
```

## Executor Flow

```mermaid
sequenceDiagram
    participant SCH as cycle-unlock-scheduler
    participant DB as SQLite DB
    participant TB as TransactionBuilder
    participant BCH as BCH Node

    loop Every 60 seconds
        SCH->>DB: Query active recurring payments where next_payment <= now
        DB->>SCH: Eligible covenants
        SCH->>TB: Build pay() transaction
        TB->>BCH: Broadcast transaction
        BCH->>TB: Transaction ID
        TB->>DB: Record execution + advance next_payment_date
    end
```

## Backend Service Map

| Service | Responsibility |
|-|-|
| `StreamDeploymentService` | Deploy `VestingCovenant` and `RecurringPaymentCovenant` |
| `StreamClaimService` | Build `claim()` transactions for vesting |
| `StreamCancelService` | Build `cancel()` transactions |
| `StreamFundingService` | Fund existing stream UTXOs |
| `PaymentDeploymentService` | Deploy `RecurringPaymentCovenant` |
| `PaymentClaimService` | Build `pay()` transactions |
| `PaymentControlService` | Pause, resume, cancel payments |
| `AirdropDeploymentService` | Deploy `AirdropCovenant` |
| `AirdropClaimService` | Build `claim()` for airdrop self-service |
| `AirdropControlService` | Authority pause/resume/cancel |
| `BudgetDeploymentService` | Deploy Grant, Bounty, Reward covenants |
| `BudgetReleaseService` | Release milestones, issue rewards, approve bounty claims |
| `VaultFundingService` | Fund vault UTXOs |
| `VoteDeploymentService` | Deploy `VoteLockCovenant` |
| `VoteLockService` | Lock governance tokens |
| `VoteUnlockService` | Reclaim after unlock time |
| `ProposalService` | Full proposal lifecycle management |
| `DeploymentRegistryService` | Track all covenant deployments |
| `TransactionMonitor` | Confirm and track submitted transactions |
| `MerkleTreeService` | Merkle tree generation for airdrop eligibility |
| `cycle-unlock-scheduler` | Executor loop for recurring payments |

{
  "contractName": "RewardCovenant",
  "constructorInputs": [
    {
      "name": "vaultId",
      "type": "bytes32"
    },
    {
      "name": "authorityHash",
      "type": "bytes20"
    },
    {
      "name": "maxRewardAmount",
      "type": "int"
    },
    {
      "name": "totalPool",
      "type": "int"
    },
    {
      "name": "startTimestamp",
      "type": "int"
    },
    {
      "name": "endTimestamp",
      "type": "int"
    }
  ],
  "abi": [
    {
      "name": "reward",
      "inputs": [
        {
          "name": "authSig",
          "type": "sig"
        },
        {
          "name": "authPubkey",
          "type": "pubkey"
        },
        {
          "name": "recipientHash",
          "type": "bytes20"
        },
        {
          "name": "rewardAmount",
          "type": "int"
        }
      ]
    },
    {
      "name": "pause",
      "inputs": [
        {
          "name": "authSig",
          "type": "sig"
        },
        {
          "name": "authPubkey",
          "type": "pubkey"
        }
      ]
    },
    {
      "name": "resume",
      "inputs": [
        {
          "name": "authSig",
          "type": "sig"
        },
        {
          "name": "authPubkey",
          "type": "pubkey"
        }
      ]
    },
    {
      "name": "cancel",
      "inputs": [
        {
          "name": "authSig",
          "type": "sig"
        },
        {
          "name": "authPubkey",
          "type": "pubkey"
        }
      ]
    }
  ],
  "bytecode": "OP_6 OP_PICK OP_0 OP_NUMEQUAL OP_IF OP_0 OP_UTXOTOKENCOMMITMENT OP_DUP OP_1 OP_SPLIT OP_DROP OP_BIN2NUM OP_OVER OP_1 OP_SPLIT OP_NIP OP_1 OP_SPLIT OP_DROP OP_2 OP_PICK OP_2 OP_SPLIT OP_NIP OP_1 OP_SPLIT OP_DROP OP_3 OP_PICK OP_3 OP_SPLIT OP_NIP OP_8 OP_SPLIT OP_DROP OP_BIN2NUM OP_4 OP_ROLL OP_11 OP_SPLIT OP_NIP OP_8 OP_SPLIT OP_DROP OP_BIN2NUM OP_13 OP_PICK OP_HASH160 OP_7 OP_ROLL OP_EQUALVERIFY OP_11 OP_ROLL OP_12 OP_ROLL OP_CHECKSIGVERIFY OP_4 OP_ROLL OP_0 OP_NUMEQUALVERIFY OP_7 OP_PICK OP_0 OP_GREATERTHAN OP_IF OP_TXLOCKTIME OP_8 OP_PICK OP_GREATERTHANOREQUAL OP_VERIFY OP_ENDIF OP_8 OP_PICK OP_0 OP_GREATERTHAN OP_IF OP_TXLOCKTIME OP_9 OP_PICK OP_LESSTHANOREQUAL OP_VERIFY OP_ENDIF OP_11 OP_PICK OP_0 OP_GREATERTHAN OP_VERIFY OP_11 OP_PICK OP_6 OP_ROLL OP_LESSTHANOREQUAL OP_VERIFY OP_SWAP OP_10 OP_PICK OP_ADD OP_DUP OP_6 OP_PICK OP_LESSTHANOREQUAL OP_VERIFY OP_0 OP_OUTPUTBYTECODE 76a914 OP_11 OP_ROLL OP_CAT 88ac OP_CAT OP_EQUALVERIFY OP_3 OP_PICK OP_4 OP_AND OP_4 OP_EQUAL OP_IF OP_0 OP_OUTPUTTOKENCATEGORY OP_0 OP_UTXOTOKENCATEGORY OP_EQUALVERIFY OP_0 OP_OUTPUTTOKENAMOUNT OP_10 OP_PICK OP_NUMEQUALVERIFY OP_ELSE OP_0 OP_OUTPUTVALUE OP_10 OP_PICK OP_NUMEQUALVERIFY OP_ENDIF OP_SWAP OP_1ADD OP_0 OP_2 OP_PICK OP_7 OP_ROLL OP_GREATERTHANOREQUAL OP_IF OP_DROP OP_3 OP_ENDIF OP_1 OP_NUM2BIN OP_4 OP_ROLL OP_CAT OP_3 OP_ROLL OP_CAT OP_ROT OP_8 OP_NUM2BIN OP_CAT OP_SWAP OP_8 OP_NUM2BIN OP_CAT OP_TXLOCKTIME OP_5 OP_NUM2BIN OP_CAT 00000000000000000000000000000000 OP_CAT OP_1 OP_OUTPUTTOKENCOMMITMENT OP_EQUALVERIFY OP_1 OP_OUTPUTTOKENCATEGORY OP_0 OP_UTXOTOKENCATEGORY OP_EQUALVERIFY OP_1 OP_OUTPUTBYTECODE OP_0 OP_UTXOBYTECODE OP_EQUALVERIFY 0000000000000000000000000000000000000000000000000000000000000000 OP_EQUAL OP_NOT OP_VERIFY OP_2DROP OP_2DROP OP_1 OP_ELSE OP_6 OP_PICK OP_1 OP_NUMEQUAL OP_IF OP_0 OP_UTXOTOKENCOMMITMENT OP_DUP OP_1 OP_SPLIT OP_DROP OP_BIN2NUM OP_OVER OP_1 OP_SPLIT OP_NIP OP_1 OP_SPLIT OP_DROP OP_11 OP_PICK OP_HASH160 OP_5 OP_ROLL OP_EQUALVERIFY OP_9 OP_ROLL OP_10 OP_ROLL OP_CHECKSIGVERIFY OP_1 OP_AND OP_1 OP_EQUALVERIFY OP_0 OP_NUMEQUALVERIFY OP_1 OP_SWAP OP_1 OP_SPLIT OP_NIP 17 OP_SPLIT OP_DROP OP_CAT 00000000000000000000000000000000 OP_CAT OP_0 OP_OUTPUTTOKENCOMMITMENT OP_EQUALVERIFY OP_0 OP_OUTPUTTOKENCATEGORY OP_0 OP_UTXOTOKENCATEGORY OP_EQUALVERIFY OP_0 OP_OUTPUTBYTECODE OP_0 OP_UTXOBYTECODE OP_EQUALVERIFY OP_2DROP OP_2DROP OP_2DROP OP_1 OP_ELSE OP_6 OP_PICK OP_2 OP_NUMEQUAL OP_IF OP_0 OP_UTXOTOKENCOMMITMENT OP_DUP OP_1 OP_SPLIT OP_DROP OP_BIN2NUM OP_10 OP_PICK OP_HASH160 OP_4 OP_ROLL OP_EQUALVERIFY OP_8 OP_ROLL OP_9 OP_ROLL OP_CHECKSIGVERIFY OP_1 OP_NUMEQUALVERIFY 00 OP_SWAP OP_1 OP_SPLIT OP_NIP 17 OP_SPLIT OP_DROP OP_CAT 00000000000000000000000000000000 OP_CAT OP_0 OP_OUTPUTTOKENCOMMITMENT OP_EQUALVERIFY OP_0 OP_OUTPUTTOKENCATEGORY OP_0 OP_UTXOTOKENCATEGORY OP_EQUALVERIFY OP_0 OP_OUTPUTBYTECODE OP_0 OP_UTXOBYTECODE OP_EQUALVERIFY OP_2DROP OP_2DROP OP_2DROP OP_1 OP_ELSE OP_6 OP_ROLL OP_3 OP_NUMEQUALVERIFY OP_0 OP_UTXOTOKENCOMMITMENT OP_DUP OP_1 OP_SPLIT OP_DROP OP_BIN2NUM OP_OVER OP_1 OP_SPLIT OP_NIP OP_1 OP_SPLIT OP_DROP OP_ROT OP_3 OP_SPLIT OP_NIP OP_8 OP_SPLIT OP_DROP OP_BIN2NUM OP_10 OP_PICK OP_HASH160 OP_5 OP_PICK OP_EQUALVERIFY OP_9 OP_ROLL OP_10 OP_ROLL OP_CHECKSIGVERIFY OP_OVER OP_1 OP_AND OP_1 OP_EQUALVERIFY OP_2 OP_PICK OP_0 OP_NUMEQUAL OP_3 OP_ROLL OP_1 OP_NUMEQUAL OP_BOOLOR OP_VERIFY OP_5 OP_ROLL OP_SWAP OP_SUB OP_DUP OP_0 OP_GREATERTHAN OP_VERIFY OP_0 OP_OUTPUTBYTECODE 76a914 OP_5 OP_ROLL OP_CAT 88ac OP_CAT OP_EQUALVERIFY OP_SWAP OP_4 OP_AND OP_4 OP_EQUAL OP_IF OP_0 OP_OUTPUTTOKENCATEGORY OP_0 OP_UTXOTOKENCATEGORY OP_EQUALVERIFY OP_0 OP_OUTPUTTOKENAMOUNT OP_OVER OP_NUMEQUALVERIFY OP_ELSE OP_0 OP_OUTPUTVALUE OP_OVER OP_NUMEQUALVERIFY OP_ENDIF OP_2DROP OP_2DROP OP_DROP OP_1 OP_ENDIF OP_ENDIF OP_ENDIF",
  "source": "/**\n * RewardCovenant — Production Grade\n *\n * ENFORCEABILITY: [ENFORCEABLE-NOW]\n *\n * PURPOSE: Enforce achievement-based variable reward distributions.\n *          Unlike airdrops (fixed equal amounts), rewards are variable —\n *          authority decides exact amount per reward event.\n *\n * NFT COMMITMENT (40 bytes — within CashTokens 40-byte limit):\n *   [0]:     status (uint8: 0=ACTIVE, 1=PAUSED, 2=CANCELLED, 3=COMPLETED)\n *   [1]:     flags (uint8: bit0=cancelable, bit2=usesTokens)\n *   [2]:     reward_category (uint8: 1=ACHIEVEMENT, 2=REFERRAL, 3=LOYALTY, 4=CUSTOM)\n *   [3-10]:  total_distributed (uint64)\n *   [11-18]: rewards_count (uint64)\n *   [19-23]: last_reward_timestamp (5 bytes)\n *   [24-39]: reserved (16 bytes)\n *\n * CONTRACT PARAMETERS (compiled into bytecode, immutable):\n *   vaultId         — links reward program to source vault\n *   authorityHash   — hash160(authority pubkey)\n *   maxRewardAmount — maximum per single reward (upper bound)\n *   totalPool       — total reward budget\n *   startTimestamp  — when rewards open (0 = immediate)\n *   endTimestamp    — when rewards close (0 = no expiry)\n */\n\npragma cashscript ^0.13.0;\n\ncontract RewardCovenant(\n    bytes32 vaultId,\n    bytes20 authorityHash,\n    int maxRewardAmount,\n    int totalPool,\n    int startTimestamp,\n    int endTimestamp\n) {\n    function reward(sig authSig, pubkey authPubkey, bytes20 recipientHash, int rewardAmount) {\n        bytes c = tx.inputs[0].nftCommitment;\n        int status            = int(c.split(1)[0]);\n        bytes1 flagsByte      = c.split(1)[1].split(1)[0];\n        bytes1 categoryByte   = c.split(2)[1].split(1)[0];\n        int totalDistributed  = int(c.split(3)[1].split(8)[0]);\n        int rewardsCount      = int(c.split(11)[1].split(8)[0]);\n\n        require(hash160(authPubkey) == authorityHash);\n        require(checkSig(authSig, authPubkey));\n        require(status == 0); // ACTIVE\n\n        if (startTimestamp > 0) { require(tx.locktime >= startTimestamp); }\n        if (endTimestamp > 0)   { require(tx.locktime <= endTimestamp); }\n\n        require(rewardAmount > 0);\n        require(rewardAmount <= maxRewardAmount);\n\n        int newTotalDistributed = totalDistributed + rewardAmount;\n        require(newTotalDistributed <= totalPool);\n\n        require(tx.outputs[0].lockingBytecode == new LockingBytecodeP2PKH(recipientHash));\n\n        if ((flagsByte & 0x04) == 0x04) {\n            require(tx.outputs[0].tokenCategory == tx.inputs[0].tokenCategory);\n            require(tx.outputs[0].tokenAmount == rewardAmount);\n        } else {\n            require(tx.outputs[0].value == rewardAmount);\n        }\n\n        int newRewardsCount = rewardsCount + 1;\n        int newStatus = 0;\n        if (newTotalDistributed >= totalPool) { newStatus = 3; } // COMPLETED\n\n        bytes newCommitment =\n            toPaddedBytes(newStatus, 1) +\n            flagsByte +\n            categoryByte +\n            toPaddedBytes(newTotalDistributed, 8) +\n            toPaddedBytes(newRewardsCount, 8) +\n            toPaddedBytes(tx.locktime, 5) +\n            0x00000000000000000000000000000000;\n\n        require(tx.outputs[1].nftCommitment == newCommitment);\n        require(tx.outputs[1].tokenCategory == tx.inputs[0].tokenCategory);\n        require(tx.outputs[1].lockingBytecode == tx.inputs[0].lockingBytecode);\n        require(vaultId != 0x0000000000000000000000000000000000000000000000000000000000000000);\n    }\n\n    function pause(sig authSig, pubkey authPubkey) {\n        bytes c = tx.inputs[0].nftCommitment;\n        int status       = int(c.split(1)[0]);\n        bytes1 flagsByte = c.split(1)[1].split(1)[0];\n\n        require(hash160(authPubkey) == authorityHash);\n        require(checkSig(authSig, authPubkey));\n        require((flagsByte & 0x01) == 0x01);\n        require(status == 0); // ACTIVE\n\n        bytes newCommitment =\n            0x01 +\n            c.split(1)[1].split(23)[0] +\n            0x00000000000000000000000000000000;\n\n        require(tx.outputs[0].nftCommitment == newCommitment);\n        require(tx.outputs[0].tokenCategory == tx.inputs[0].tokenCategory);\n        require(tx.outputs[0].lockingBytecode == tx.inputs[0].lockingBytecode);\n    }\n\n    function resume(sig authSig, pubkey authPubkey) {\n        bytes c = tx.inputs[0].nftCommitment;\n        int status = int(c.split(1)[0]);\n\n        require(hash160(authPubkey) == authorityHash);\n        require(checkSig(authSig, authPubkey));\n        require(status == 1); // PAUSED\n\n        bytes newCommitment =\n            0x00 +\n            c.split(1)[1].split(23)[0] +\n            0x00000000000000000000000000000000;\n\n        require(tx.outputs[0].nftCommitment == newCommitment);\n        require(tx.outputs[0].tokenCategory == tx.inputs[0].tokenCategory);\n        require(tx.outputs[0].lockingBytecode == tx.inputs[0].lockingBytecode);\n    }\n\n    function cancel(sig authSig, pubkey authPubkey) {\n        bytes c = tx.inputs[0].nftCommitment;\n        int status           = int(c.split(1)[0]);\n        bytes1 flagsByte     = c.split(1)[1].split(1)[0];\n        int totalDistributed = int(c.split(3)[1].split(8)[0]);\n\n        require(hash160(authPubkey) == authorityHash);\n        require(checkSig(authSig, authPubkey));\n        require((flagsByte & 0x01) == 0x01);\n        require(status == 0 || status == 1);\n\n        int remainingPool = totalPool - totalDistributed;\n        require(remainingPool > 0);\n\n        require(tx.outputs[0].lockingBytecode == new LockingBytecodeP2PKH(authorityHash));\n\n        if ((flagsByte & 0x04) == 0x04) {\n            require(tx.outputs[0].tokenCategory == tx.inputs[0].tokenCategory);\n            require(tx.outputs[0].tokenAmount == remainingPool);\n        } else {\n            require(tx.outputs[0].value == remainingPool);\n        }\n    }\n}\n",
  "debug": {
    "bytecode": "5679009c6300cf76517f758178517f77517f755279527f77517f755379537f77587f7581547a5b7f77587f75815d79a9577a885b7a5c7aad547a009d577900a063c55879a26968587900a063c55979a169685b7900a0695b79567aa1697c5a7993765679a16900cd0376a9145b7a7e0288ac7e885379548454876300d100ce8800d35a799d6700cc5a799d687c8b005279577aa2637553685180547a7e537a7e7b58807e7c58807ec555807e10000000000000000000000000000000007e51d28851d100ce8851cd00c7882000000000000000000000000000000000000000000000000000000000000000008791696d6d51675679519c6300cf76517f758178517f77517f755b79a9557a88597a5a7aad51845188009d517c517f7701177f757e10000000000000000000000000000000007e00d28800d100ce8800cd00c7886d6d6d51675679529c6300cf76517f75815a79a9547a88587a597aad519d01007c517f7701177f757e10000000000000000000000000000000007e00d28800d100ce8800cd00c7886d6d6d5167567a539d00cf76517f758178517f77517f757b537f77587f75815a79a9557988597a5a7aad78518451885279009c537a519c9b69557a7c947600a06900cd0376a914557a7e0288ac7e887c548454876300d100ce8800d3789d6700cc789d686d6d7551686868",
    "sourceMap": "38:4:85:5;;;;;39:28:39:29;:18::44:1;40:36:40:37:0;:44::45;:36::46:1;:::49;:32::50;41::41:33:0;:40::41;:32::42:1;:::45;:52::53:0;:32::54:1;:::57;42::42:33:0;;:40::41;:32::42:1;:::45;:52::53:0;:32::54:1;:::57;43:36:43:37:0;;:44::45;:36::46:1;:::49;:56::57:0;:36::58:1;:::61;:32::62;44:36:44:37:0;;:44::46;:36::47:1;:::50;:57::58:0;:36::59:1;:::62;:32::63;46:24:46:34:0;;:16::35:1;:39::52:0;;:8::54:1;47:25:47:32:0;;:34::44;;:8::47:1;48:16:48:22:0;;:26::27;:8::29:1;50:12:50:26:0;;:29::30;:12:::1;:32::75:0;:42::53;:57::71;;:42:::1;:34::73;:32::75;51:12:51:24:0;;:27::28;:12:::1;:32::73:0;:42::53;:57::69;;:42:::1;:34::71;:32::73;53:16:53:28:0;;:31::32;:16:::1;:8::34;54:16:54:28:0;;:32::47;;:16:::1;:8::49;56:34:56:50:0;:53::65;;:34:::1;57:16:57:35:0;:39::48;;:16:::1;:8::50;59:27:59:28:0;:16::45:1;:49::88:0;:74::87;;:49::88:1;;;:8::90;61:13:61:22:0;;:25::29;:13:::1;:34::38:0;:12:::1;:40:64:9:0;62:31:62:32;:20::47:1;:61::62:0;:51::77:1;:12::79;63:31:63:32:0;:20::45:1;:49::61:0;;:12::63:1;64:15:66:9:0;65:31:65:32;:20::39:1;:43::55:0;;:12::57:1;64:15:66:9;68:30:68:42:0;:::46:1;69:24:69:25:0;70:12:70:31;;:35::44;;:12:::1;:46::64:0;:48::62:1;;:46::64;73:37:73:38:0;:12::39:1;74::74:21:0;;73::::1;75::75:24:0;;73::::1;76:26:76:45:0;:47::48;:12::49:1;73;77:26:77:41:0;:43::44;:12::45:1;73;78:26:78:37:0;:39::40;:12::41:1;73;79::79:46:0;73::::1;81:27:81:28:0;:16::43:1;:8::62;82:27:82:28:0;:16::43:1;:57::58:0;:47::73:1;:8::75;83:27:83:28:0;:16::45:1;:59::60:0;:49::77:1;:8::79;84:27:84:93:0;:16:::1;;:8::95;38:4:85:5;;;;87::105::0;;;;;88:28:88:29;:18::44:1;89:31:89:32:0;:39::40;:31::41:1;:::44;:27::45;90::90:28:0;:35::36;:27::37:1;:::40;:47::48:0;:27::49:1;:::52;92:24:92:34:0;;:16::35:1;:39::52:0;;:8::54:1;93:25:93:32:0;;:34::44;;:8::47:1;94:29:94:33:0;:17:::1;:38::42:0;:8::44:1;95:26:95:27:0;:8::29:1;98:12:98:16:0;99::99:13;:20::21;:12::22:1;:::25;:32::34:0;:12::35:1;:::38;98;100::100:46:0;98::::1;102:27:102:28:0;:16::43:1;:8::62;103:27:103:28:0;:16::43:1;:57::58:0;:47::73:1;:8::75;104:27:104:28:0;:16::45:1;:59::60:0;:49::77:1;:8::79;87:4:105:5;;;;;107::123::0;;;;;108:28:108:29;:18::44:1;109:25:109:26:0;:33::34;:25::35:1;:::38;:21::39;111:24:111:34:0;;:16::35:1;:39::52:0;;:8::54:1;112:25:112:32:0;;:34::44;;:8::47:1;113:26:113:27:0;:8::29:1;116:12:116:16:0;117::117:13;:20::21;:12::22:1;:::25;:32::34:0;:12::35:1;:::38;116;118::118:46:0;116::::1;120:27:120:28:0;:16::43:1;:8::62;121:27:121:28:0;:16::43:1;:57::58:0;:47::73:1;:8::75;122:27:122:28:0;:16::45:1;:59::60:0;:49::77:1;:8::79;107:4:123:5;;;;;125::147::0;;;;126:28:126:29;:18::44:1;127:35:127:36:0;:43::44;:35::45:1;:::48;:31::49;128::128:32:0;:39::40;:31::41:1;:::44;:51::52:0;:31::53:1;:::56;129:35:129:36:0;:43::44;:35::45:1;:::48;:55::56:0;:35::57:1;:::60;:31::61;131:24:131:34:0;;:16::35:1;:39::52:0;;:8::54:1;132:25:132:32:0;;:34::44;;:8::47:1;133:17:133:26:0;:29::33;:17:::1;:38::42:0;:8::44:1;134:16:134:22:0;;:26::27;:16:::1;:31::37:0;;:41::42;:31:::1;:16;:8::44;136:28:136:37:0;;:40::56;:28:::1;137:16:137:29:0;:32::33;:16:::1;:8::35;139:27:139:28:0;:16::45:1;:49::88:0;:74::87;;:49::88:1;;;:8::90;141:13:141:22:0;:25::29;:13:::1;:34::38:0;:12:::1;:40:144:9:0;142:31:142:32;:20::47:1;:61::62:0;:51::77:1;:12::79;143:31:143:32:0;:20::45:1;:49::62:0;:12::64:1;144:15:146:9:0;145:31:145:32;:20::39:1;:43::56:0;:12::58:1;144:15:146:9;125:4:147:5;;;;30:0:148:1;;",
    "logs": [],
    "requires": [
      {
        "ip": 56,
        "line": 46
      },
      {
        "ip": 61,
        "line": 47
      },
      {
        "ip": 65,
        "line": 48
      },
      {
        "ip": 75,
        "line": 50
      },
      {
        "ip": 86,
        "line": 51
      },
      {
        "ip": 92,
        "line": 53
      },
      {
        "ip": 98,
        "line": 54
      },
      {
        "ip": 107,
        "line": 57
      },
      {
        "ip": 116,
        "line": 59
      },
      {
        "ip": 128,
        "line": 62
      },
      {
        "ip": 133,
        "line": 63
      },
      {
        "ip": 139,
        "line": 65
      },
      {
        "ip": 177,
        "line": 81
      },
      {
        "ip": 182,
        "line": 82
      },
      {
        "ip": 187,
        "line": 83
      },
      {
        "ip": 191,
        "line": 84
      },
      {
        "ip": 220,
        "line": 92
      },
      {
        "ip": 225,
        "line": 93
      },
      {
        "ip": 229,
        "line": 94
      },
      {
        "ip": 231,
        "line": 95
      },
      {
        "ip": 245,
        "line": 102
      },
      {
        "ip": 250,
        "line": 103
      },
      {
        "ip": 255,
        "line": 104
      },
      {
        "ip": 278,
        "line": 111
      },
      {
        "ip": 283,
        "line": 112
      },
      {
        "ip": 285,
        "line": 113
      },
      {
        "ip": 299,
        "line": 120
      },
      {
        "ip": 304,
        "line": 121
      },
      {
        "ip": 309,
        "line": 122
      },
      {
        "ip": 346,
        "line": 131
      },
      {
        "ip": 351,
        "line": 132
      },
      {
        "ip": 356,
        "line": 133
      },
      {
        "ip": 366,
        "line": 134
      },
      {
        "ip": 374,
        "line": 137
      },
      {
        "ip": 383,
        "line": 139
      },
      {
        "ip": 394,
        "line": 142
      },
      {
        "ip": 398,
        "line": 143
      },
      {
        "ip": 403,
        "line": 145
      }
    ]
  },
  "compiler": {
    "name": "cashc",
    "version": "0.13.0-next.3"
  },
  "updatedAt": "2026-02-26T11:10:55.350Z"
}
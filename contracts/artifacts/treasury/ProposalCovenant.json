{
  "contractName": "ProposalCovenant",
  "constructorInputs": [
    {
      "name": "vaultId",
      "type": "bytes32"
    },
    {
      "name": "signer1Hash",
      "type": "bytes20"
    },
    {
      "name": "signer2Hash",
      "type": "bytes20"
    },
    {
      "name": "signer3Hash",
      "type": "bytes20"
    },
    {
      "name": "requiredApprovals",
      "type": "int"
    }
  ],
  "abi": [
    {
      "name": "approve",
      "inputs": [
        {
          "name": "approverSig",
          "type": "sig"
        },
        {
          "name": "approverPubkey",
          "type": "pubkey"
        }
      ]
    },
    {
      "name": "execute",
      "inputs": []
    },
    {
      "name": "cancel",
      "inputs": [
        {
          "name": "sig1",
          "type": "sig"
        },
        {
          "name": "pubkey1",
          "type": "pubkey"
        },
        {
          "name": "sig2",
          "type": "sig"
        },
        {
          "name": "pubkey2",
          "type": "pubkey"
        }
      ]
    },
    {
      "name": "expire",
      "inputs": []
    }
  ],
  "bytecode": "OP_5 OP_PICK OP_0 OP_NUMEQUAL OP_IF OP_0 OP_UTXOTOKENCOMMITMENT OP_DUP OP_1 OP_SPLIT OP_NIP OP_1 OP_SPLIT OP_DROP OP_BIN2NUM OP_OVER OP_2 OP_SPLIT OP_NIP OP_1 OP_SPLIT OP_DROP OP_10 OP_PICK OP_HASH160 OP_DUP OP_6 OP_PICK OP_EQUAL OP_OVER OP_8 OP_PICK OP_EQUAL OP_BOOLOR OP_OVER OP_9 OP_PICK OP_EQUAL OP_BOOLOR OP_VERIFY OP_10 OP_ROLL OP_11 OP_ROLL OP_CHECKSIGVERIFY OP_ROT OP_0 OP_NUMEQUALVERIFY 00 OP_OVER OP_6 OP_ROLL OP_EQUAL OP_IF OP_DROP OP_1 OP_ENDIF OP_OVER OP_6 OP_ROLL OP_EQUAL OP_IF OP_DROP OP_2 OP_ENDIF OP_SWAP OP_5 OP_ROLL OP_EQUAL OP_IF OP_DROP OP_4 OP_ENDIF OP_2DUP OP_AND 00 OP_EQUALVERIFY OP_OVER OP_BIN2NUM OP_SWAP OP_BIN2NUM OP_ADD OP_0 OP_2 OP_PICK OP_1 OP_AND OP_1 OP_EQUAL OP_IF OP_DUP OP_1ADD OP_NIP OP_ENDIF OP_2 OP_PICK OP_2 OP_AND OP_2 OP_EQUAL OP_IF OP_DUP OP_1ADD OP_NIP OP_ENDIF OP_ROT OP_4 OP_AND OP_4 OP_EQUAL OP_IF OP_DUP OP_1ADD OP_NIP OP_ENDIF OP_DUP OP_1ADD OP_0 OP_SWAP OP_6 OP_ROLL OP_GREATERTHANOREQUAL OP_IF OP_DROP OP_1 OP_ENDIF OP_3 OP_PICK OP_1 OP_SPLIT OP_DROP OP_SWAP OP_1 OP_NUM2BIN OP_CAT OP_ROT OP_1 OP_NUM2BIN OP_CAT OP_ROT OP_3 OP_SPLIT OP_NIP 1f OP_SPLIT OP_DROP OP_CAT 000000000000 OP_CAT OP_0 OP_OUTPUTTOKENCOMMITMENT OP_EQUALVERIFY OP_0 OP_OUTPUTTOKENCATEGORY OP_0 OP_UTXOTOKENCATEGORY OP_EQUALVERIFY OP_0 OP_OUTPUTBYTECODE OP_0 OP_UTXOBYTECODE OP_EQUAL OP_NIP OP_NIP OP_NIP OP_ELSE OP_5 OP_PICK OP_1 OP_NUMEQUAL OP_IF OP_0 OP_UTXOTOKENCOMMITMENT OP_DUP OP_1 OP_SPLIT OP_NIP OP_1 OP_SPLIT OP_DROP OP_BIN2NUM OP_SWAP OP_9 OP_SPLIT OP_NIP OP_5 OP_SPLIT OP_DROP OP_BIN2NUM OP_SWAP OP_1 OP_NUMEQUALVERIFY OP_TXLOCKTIME OP_LESSTHANOREQUAL OP_VERIFY 0000000000000000000000000000000000000000000000000000000000000000 OP_EQUAL OP_NOT OP_VERIFY OP_2DROP OP_2DROP OP_DROP OP_1 OP_ELSE OP_5 OP_PICK OP_2 OP_NUMEQUAL OP_IF OP_0 OP_UTXOTOKENCOMMITMENT OP_DUP OP_1 OP_SPLIT OP_NIP OP_1 OP_SPLIT OP_DROP OP_BIN2NUM OP_9 OP_PICK OP_HASH160 OP_12 OP_PICK OP_HASH160 OP_OVER OP_6 OP_PICK OP_EQUAL OP_2 OP_PICK OP_8 OP_PICK OP_EQUAL OP_BOOLOR OP_2 OP_PICK OP_9 OP_PICK OP_EQUAL OP_BOOLOR OP_VERIFY OP_DUP OP_6 OP_ROLL OP_EQUAL OP_OVER OP_7 OP_ROLL OP_EQUAL OP_BOOLOR OP_OVER OP_7 OP_ROLL OP_EQUAL OP_BOOLOR OP_VERIFY OP_EQUAL OP_NOT OP_VERIFY OP_5 OP_ROLL OP_6 OP_ROLL OP_CHECKSIGVERIFY OP_5 OP_ROLL OP_6 OP_ROLL OP_CHECKSIGVERIFY OP_DUP OP_0 OP_NUMEQUAL OP_SWAP OP_1 OP_NUMEQUAL OP_BOOLOR OP_VERIFY OP_DUP OP_1 OP_SPLIT OP_DROP OP_3 OP_CAT OP_SWAP OP_2 OP_SPLIT OP_NIP 20 OP_SPLIT OP_DROP OP_CAT 000000000000 OP_CAT OP_0 OP_OUTPUTTOKENCOMMITMENT OP_EQUALVERIFY OP_0 OP_OUTPUTTOKENCATEGORY OP_0 OP_UTXOTOKENCATEGORY OP_EQUALVERIFY OP_0 OP_OUTPUTBYTECODE OP_0 OP_UTXOBYTECODE OP_EQUAL OP_NIP OP_NIP OP_NIP OP_ELSE OP_5 OP_ROLL OP_3 OP_NUMEQUALVERIFY OP_0 OP_UTXOTOKENCOMMITMENT OP_DUP OP_1 OP_SPLIT OP_NIP OP_1 OP_SPLIT OP_DROP OP_BIN2NUM OP_OVER OP_4 OP_SPLIT OP_NIP OP_5 OP_SPLIT OP_DROP OP_BIN2NUM OP_SWAP OP_0 OP_NUMEQUALVERIFY OP_DUP OP_0 OP_GREATERTHAN OP_VERIFY OP_TXLOCKTIME OP_LESSTHANOREQUAL OP_VERIFY OP_DUP OP_1 OP_SPLIT OP_DROP OP_4 OP_CAT OP_SWAP OP_2 OP_SPLIT OP_NIP 20 OP_SPLIT OP_DROP OP_CAT 000000000000 OP_CAT OP_0 OP_OUTPUTTOKENCOMMITMENT OP_EQUALVERIFY OP_0 OP_OUTPUTTOKENCATEGORY OP_0 OP_UTXOTOKENCATEGORY OP_EQUALVERIFY OP_0 OP_OUTPUTBYTECODE OP_0 OP_UTXOBYTECODE OP_EQUALVERIFY OP_2DROP OP_2DROP OP_DROP OP_1 OP_ENDIF OP_ENDIF OP_ENDIF",
  "source": "/**\n * ProposalCovenant — Production Grade\n *\n * ENFORCEABILITY: [ENFORCEABLE-NOW]\n *\n * PURPOSE: Manage spending proposal lifecycle\n * - Track M-of-N approvals with signer identity validation\n * - Enforce status transitions (PENDING → APPROVED → EXECUTED)\n * - Enforce execution timelock (CLTV)\n * - Cancel by M-of-N, expire after voting deadline\n *\n * NFT COMMITMENT (40 bytes — within CashTokens 40-byte limit):\n *   [0]:     version (uint8)\n *   [1]:     status (uint8: 0=PENDING, 1=APPROVED, 2=EXECUTED, 3=CANCELLED, 4=EXPIRED)\n *   [2]:     approval_bitmask (uint8: bit0=signer1, bit1=signer2, bit2=signer3)\n *   [3]:     required_approvals (uint8)\n *   [4-8]:   voting_end_timestamp (5 bytes)\n *   [9-13]:  execution_timelock (5 bytes)\n *   [14-33]: payout_hash (bytes20)\n *   [34-39]: reserved\n *\n * CONTRACT PARAMETERS (compiled into bytecode, immutable):\n *   vaultId           — links proposal to vault\n *   signer1Hash       — hash160 of vault signer 1\n *   signer2Hash       — hash160 of vault signer 2\n *   signer3Hash       — hash160 of vault signer 3\n *   requiredApprovals — M in M-of-N\n */\n\npragma cashscript ^0.13.0;\n\ncontract ProposalCovenant(\n    bytes32 vaultId,\n    bytes20 signer1Hash,\n    bytes20 signer2Hash,\n    bytes20 signer3Hash,\n    int requiredApprovals\n) {\n    /**\n     * approve() — Vault signer adds their approval\n     *\n     * Uses a per-signer bitmask to prevent the same signer from\n     * voting twice and self-approving a proposal alone.\n     */\n    function approve(sig approverSig, pubkey approverPubkey) {\n        bytes c = tx.inputs[0].nftCommitment;\n        int status          = int(c.split(1)[1].split(1)[0]);\n        bytes1 approvalMask = c.split(2)[1].split(1)[0];\n\n        bytes20 pkHash = hash160(approverPubkey);\n        require(pkHash == signer1Hash || pkHash == signer2Hash || pkHash == signer3Hash);\n        require(checkSig(approverSig, approverPubkey));\n        require(status == 0); // PENDING\n\n        // Map signer to their bit in the approval mask\n        bytes1 signerBit = 0x00;\n        if (pkHash == signer1Hash) { signerBit = 0x01; }\n        if (pkHash == signer2Hash) { signerBit = 0x02; }\n        if (pkHash == signer3Hash) { signerBit = 0x04; }\n\n        // Reject if this signer has already approved\n        require((approvalMask & signerBit) == 0x00);\n\n        // Set signer's bit (safe: addition == OR when the bit was 0)\n        int newMask = int(approvalMask) + int(signerBit);\n\n        // Count total approvers after this vote\n        int approvalCount = 0;\n        if ((approvalMask & 0x01) == 0x01) { approvalCount = approvalCount + 1; }\n        if ((approvalMask & 0x02) == 0x02) { approvalCount = approvalCount + 1; }\n        if ((approvalMask & 0x04) == 0x04) { approvalCount = approvalCount + 1; }\n        approvalCount = approvalCount + 1; // include this vote\n\n        int newStatus = 0;\n        if (approvalCount >= requiredApprovals) { newStatus = 1; } // APPROVED\n\n        bytes newCommitment =\n            c.split(1)[0] +\n            toPaddedBytes(newStatus, 1) +\n            toPaddedBytes(newMask, 1) +\n            c.split(3)[1].split(31)[0] +\n            0x000000000000;\n\n        require(tx.outputs[0].nftCommitment == newCommitment);\n        require(tx.outputs[0].tokenCategory == tx.inputs[0].tokenCategory);\n        require(tx.outputs[0].lockingBytecode == tx.inputs[0].lockingBytecode);\n    }\n\n    /**\n     * execute() — Execute an approved proposal\n     *\n     * ProposalNFT is burned after execution.\n     */\n    function execute() {\n        bytes c = tx.inputs[0].nftCommitment;\n        int status            = int(c.split(1)[1].split(1)[0]);\n        int executionTimelock = int(c.split(9)[1].split(5)[0]);\n\n        require(status == 1); // APPROVED\n        require(tx.locktime >= executionTimelock);\n        require(vaultId != 0x0000000000000000000000000000000000000000000000000000000000000000);\n    }\n\n    /**\n     * cancel() — Cancel a pending or approved proposal (M-of-N)\n     */\n    function cancel(sig sig1, pubkey pubkey1, sig sig2, pubkey pubkey2) {\n        bytes c = tx.inputs[0].nftCommitment;\n        int status = int(c.split(1)[1].split(1)[0]);\n\n        bytes20 pk1Hash = hash160(pubkey1);\n        bytes20 pk2Hash = hash160(pubkey2);\n\n        require(pk1Hash == signer1Hash || pk1Hash == signer2Hash || pk1Hash == signer3Hash);\n        require(pk2Hash == signer1Hash || pk2Hash == signer2Hash || pk2Hash == signer3Hash);\n        require(pk1Hash != pk2Hash);\n\n        require(checkSig(sig1, pubkey1));\n        require(checkSig(sig2, pubkey2));\n\n        require(status == 0 || status == 1); // PENDING or APPROVED\n\n        bytes newCommitment =\n            c.split(1)[0] +\n            0x03 +\n            c.split(2)[1].split(32)[0] +\n            0x000000000000;\n\n        require(tx.outputs[0].nftCommitment == newCommitment);\n        require(tx.outputs[0].tokenCategory == tx.inputs[0].tokenCategory);\n        require(tx.outputs[0].lockingBytecode == tx.inputs[0].lockingBytecode);\n    }\n\n    /**\n     * expire() — Mark proposal expired after voting deadline (permissionless)\n     */\n    function expire() {\n        bytes c = tx.inputs[0].nftCommitment;\n        int status    = int(c.split(1)[1].split(1)[0]);\n        int votingEnd = int(c.split(4)[1].split(5)[0]);\n\n        require(status == 0); // PENDING\n        require(votingEnd > 0);\n        require(tx.locktime >= votingEnd);\n\n        bytes newCommitment =\n            c.split(1)[0] +\n            0x04 +\n            c.split(2)[1].split(32)[0] +\n            0x000000000000;\n\n        require(tx.outputs[0].nftCommitment == newCommitment);\n        require(tx.outputs[0].tokenCategory == tx.inputs[0].tokenCategory);\n        require(tx.outputs[0].lockingBytecode == tx.inputs[0].lockingBytecode);\n    }\n}\n",
  "debug": {
    "bytecode": "5579009c6300cf76517f77517f758178527f77517f755a79a976567987785879879b785979879b695a7a5b7aad7b009d010078567a876375516878567a87637552687c557a87637554686e8401008878817c81930052795184518763768b776852795284528763768b77687b5484548763768b7768768b007c567aa2637551685379517f757c51807e7b51807e7b537f77011f7f757e060000000000007e00d28800d100ce8800cd00c787777777675579519c6300cf76517f77517f75817c597f77557f75817c519dc5a1692000000000000000000000000000000000000000000000000000000000000000008791696d6d7551675579529c6300cf76517f77517f75815979a95c79a97856798752795879879b52795979879b6976567a8778577a879b78577a879b69879169557a567aad557a567aad76009c7c519c9b6976517f75537e7c527f7701207f757e060000000000007e00d28800d100ce8800cd00c78777777767557a539d00cf76517f77517f758178547f77557f75817c009d7600a069c5a16976517f75547e7c527f7701207f757e060000000000007e00d28800d100ce8800cd00c7886d6d7551686868",
    "sourceMap": "45:4:87:5;;;;;46:28:46:29;:18::44:1;47:34:47:35:0;:42::43;:34::44:1;:::47;:54::55:0;:34::56:1;:::59;:30::60;48::48:31:0;:38::39;:30::40:1;:::43;:50::51:0;:30::52:1;:::55;50:33:50:47:0;;:25::48:1;51:16:51:22:0;:26::37;;:16:::1;:41::47:0;:51::62;;:41:::1;:16;:66::72:0;:76::87;;:66:::1;:16;:8::89;52:25:52:36:0;;:38::52;;:8::55:1;53:16:53:22:0;:26::27;:8::29:1;56:27:56:31:0;57:12:57:18;:22::33;;:12:::1;:35::56:0;:37::54:1;;:35::56;58:12:58:18:0;:22::33;;:12:::1;:35::56:0;:37::54:1;;:35::56;59:12:59:18:0;:22::33;;:12:::1;:35::56:0;:37::54:1;;:35::56;62:17:62:41:0;::::1;:46::50:0;:8::52:1;65:26:65:38:0;:22::39:1;:46::55:0;:42::56:1;:22;68:28:68:29:0;69:13:69:25;;:28::32;:13:::1;:37::41:0;:12:::1;:43::81:0;:61::74;:::78:1;:45::79;:43::81;70:13:70:25:0;;:28::32;:13:::1;:37::41:0;:12:::1;:43::81:0;:61::74;:::78:1;:45::79;:43::81;71:13:71:25:0;:28::32;:13:::1;:37::41:0;:12:::1;:43::81:0;:61::74;:::78:1;:45::79;:43::81;72:24:72:37:0;:::41:1;74::74:25:0;75:12:75;:29::46;;:12:::1;:48::66:0;:50::64:1;;:48::66;78:12:78:13:0;;:20::21;:12::22:1;:::25;79:26:79:35:0;:37::38;:12::39:1;78;80:26:80:33:0;:35::36;:12::37:1;78;81::81:13:0;:20::21;:12::22:1;:::25;:32::34:0;:12::35:1;:::38;78;82::82:26:0;78::::1;84:27:84:28:0;:16::43:1;:8::62;85:27:85:28:0;:16::43:1;:57::58:0;:47::73:1;:8::75;86:27:86:28:0;:16::45:1;:59::60:0;:49::77:1;:8::79;45:4:87:5;;;;94::102::0;;;;;95:28:95:29;:18::44:1;96:36:96:37:0;:44::45;:36::46:1;:::49;:56::57:0;:36::58:1;:::61;:32::62;97:36:97:37:0;:44::45;:36::46:1;:::49;:56::57:0;:36::58:1;:::61;:32::62;99:16:99:22:0;:26::27;:8::29:1;100:16:100:27:0;:::48:1;:8::50;101:27:101:93:0;:16:::1;;:8::95;94:4:102:5;;;;;107::132::0;;;;;108:28:108:29;:18::44:1;109:25:109:26:0;:33::34;:25::35:1;:::38;:45::46:0;:25::47:1;:::50;:21::51;111:34:111:41:0;;:26::42:1;112:34:112:41:0;;:26::42:1;114:16:114:23:0;:27::38;;:16:::1;:42::49:0;;:53::64;;:42:::1;:16;:68::75:0;;:79::90;;:68:::1;:16;:8::92;115:16:115:23:0;:27::38;;:16:::1;:42::49:0;:53::64;;:42:::1;:16;:68::75:0;:79::90;;:68:::1;:16;:8::92;116:16:116:34;;:8::36;118:25:118:29:0;;:31::38;;:8::41:1;119:25:119:29:0;;:31::38;;:8::41:1;121:16:121:22:0;:26::27;:16:::1;:31::37:0;:41::42;:31:::1;:16;:8::44;124:12:124:13:0;:20::21;:12::22:1;:::25;125::125:16:0;124::::1;126::126:13:0;:20::21;:12::22:1;:::25;:32::34:0;:12::35:1;:::38;124;127::127:26:0;124::::1;129:27:129:28:0;:16::43:1;:8::62;130:27:130:28:0;:16::43:1;:57::58:0;:47::73:1;:8::75;131:27:131:28:0;:16::45:1;:59::60:0;:49::77:1;:8::79;107:4:132:5;;;;137::155::0;;;;138:28:138:29;:18::44:1;139:28:139:29:0;:36::37;:28::38:1;:::41;:48::49:0;:28::50:1;:::53;:24::54;140:28:140:29:0;:36::37;:28::38:1;:::41;:48::49:0;:28::50:1;:::53;:24::54;142:16:142:22:0;:26::27;:8::29:1;143:16:143:25:0;:28::29;:16:::1;:8::31;144:16:144:27:0;:::40:1;:8::42;147:12:147:13:0;:20::21;:12::22:1;:::25;148::148:16:0;147::::1;149::149:13:0;:20::21;:12::22:1;:::25;:32::34:0;:12::35:1;:::38;147;150::150:26:0;147::::1;152:27:152:28:0;:16::43:1;:8::62;153:27:153:28:0;:16::43:1;:57::58:0;:47::73:1;:8::75;154:27:154:28:0;:16::45:1;:59::60:0;:49::77:1;:8::79;137:4:155:5;;;;32:0:156:1;;",
    "logs": [],
    "requires": [
      {
        "ip": 44,
        "line": 51
      },
      {
        "ip": 49,
        "line": 52
      },
      {
        "ip": 52,
        "line": 53
      },
      {
        "ip": 81,
        "line": 62
      },
      {
        "ip": 156,
        "line": 84
      },
      {
        "ip": 161,
        "line": 85
      },
      {
        "ip": 167,
        "line": 86
      },
      {
        "ip": 196,
        "line": 99
      },
      {
        "ip": 199,
        "line": 100
      },
      {
        "ip": 203,
        "line": 101
      },
      {
        "ip": 246,
        "line": 114
      },
      {
        "ip": 261,
        "line": 115
      },
      {
        "ip": 264,
        "line": 116
      },
      {
        "ip": 269,
        "line": 118
      },
      {
        "ip": 274,
        "line": 119
      },
      {
        "ip": 282,
        "line": 121
      },
      {
        "ip": 301,
        "line": 129
      },
      {
        "ip": 306,
        "line": 130
      },
      {
        "ip": 312,
        "line": 131
      },
      {
        "ip": 340,
        "line": 142
      },
      {
        "ip": 344,
        "line": 143
      },
      {
        "ip": 347,
        "line": 144
      },
      {
        "ip": 366,
        "line": 152
      },
      {
        "ip": 371,
        "line": 153
      },
      {
        "ip": 376,
        "line": 154
      }
    ]
  },
  "compiler": {
    "name": "cashc",
    "version": "0.13.0-next.3"
  },
  "updatedAt": "2026-02-26T11:10:46.707Z"
}
{
  "contractName": "TallyCommitment_FixedMax",
  "constructorInputs": [
    {
      "name": "proposalId",
      "type": "bytes32"
    },
    {
      "name": "quorumThreshold",
      "type": "int"
    },
    {
      "name": "majorityThreshold",
      "type": "int"
    }
  ],
  "abi": [
    {
      "name": "createTally",
      "inputs": []
    }
  ],
  "bytecode": "OP_0 OP_1 OP_2 OP_0 OP_0 OP_0 OP_0 OP_UTXOTOKENCOMMITMENT OP_DUP OP_1 OP_SPLIT OP_NIP OP_4 OP_SPLIT OP_DROP OP_8 OP_PICK OP_4 OP_SPLIT OP_DROP OP_EQUALVERIFY OP_5 OP_SPLIT OP_NIP OP_1 OP_SPLIT OP_DROP OP_BIN2NUM OP_0 OP_UTXOTOKENAMOUNT OP_OVER OP_7 OP_PICK OP_NUMEQUAL OP_IF OP_4 OP_PICK OP_OVER OP_ADD OP_5 OP_ROLL OP_DROP OP_SWAP OP_TOALTSTACK OP_SWAP OP_TOALTSTACK OP_SWAP OP_TOALTSTACK OP_SWAP OP_FROMALTSTACK OP_FROMALTSTACK OP_FROMALTSTACK OP_ENDIF OP_OVER OP_8 OP_PICK OP_NUMEQUAL OP_IF OP_3 OP_PICK OP_OVER OP_ADD OP_4 OP_ROLL OP_DROP OP_SWAP OP_TOALTSTACK OP_SWAP OP_TOALTSTACK OP_SWAP OP_FROMALTSTACK OP_FROMALTSTACK OP_ENDIF OP_SWAP OP_5 OP_PICK OP_NUMEQUAL OP_IF OP_2DUP OP_ADD OP_ROT OP_DROP OP_SWAP OP_ENDIF OP_1 OP_UTXOTOKENCOMMITMENT OP_DUP OP_1 OP_SPLIT OP_NIP OP_4 OP_SPLIT OP_DROP OP_9 OP_PICK OP_4 OP_SPLIT OP_DROP OP_EQUALVERIFY OP_5 OP_SPLIT OP_NIP OP_1 OP_SPLIT OP_DROP OP_BIN2NUM OP_1 OP_UTXOTOKENAMOUNT OP_OVER OP_8 OP_PICK OP_NUMEQUAL OP_IF OP_5 OP_PICK OP_OVER OP_ADD OP_6 OP_ROLL OP_DROP OP_SWAP OP_TOALTSTACK OP_SWAP OP_TOALTSTACK OP_SWAP OP_TOALTSTACK OP_SWAP OP_TOALTSTACK OP_SWAP OP_FROMALTSTACK OP_FROMALTSTACK OP_FROMALTSTACK OP_FROMALTSTACK OP_ENDIF OP_OVER OP_9 OP_PICK OP_NUMEQUAL OP_IF OP_4 OP_PICK OP_OVER OP_ADD OP_5 OP_ROLL OP_DROP OP_SWAP OP_TOALTSTACK OP_SWAP OP_TOALTSTACK OP_SWAP OP_TOALTSTACK OP_SWAP OP_FROMALTSTACK OP_FROMALTSTACK OP_FROMALTSTACK OP_ENDIF OP_SWAP OP_6 OP_PICK OP_NUMEQUAL OP_IF OP_2 OP_PICK OP_OVER OP_ADD OP_3 OP_ROLL OP_DROP OP_SWAP OP_TOALTSTACK OP_SWAP OP_FROMALTSTACK OP_ENDIF OP_2 OP_UTXOTOKENCOMMITMENT OP_DUP OP_1 OP_SPLIT OP_NIP OP_4 OP_SPLIT OP_DROP OP_10 OP_PICK OP_4 OP_SPLIT OP_DROP OP_EQUALVERIFY OP_5 OP_SPLIT OP_NIP OP_1 OP_SPLIT OP_DROP OP_BIN2NUM OP_2 OP_UTXOTOKENAMOUNT OP_OVER OP_9 OP_ROLL OP_NUMEQUAL OP_IF OP_6 OP_PICK OP_OVER OP_ADD OP_7 OP_ROLL OP_DROP OP_SWAP OP_TOALTSTACK OP_SWAP OP_TOALTSTACK OP_SWAP OP_TOALTSTACK OP_SWAP OP_TOALTSTACK OP_SWAP OP_TOALTSTACK OP_SWAP OP_FROMALTSTACK OP_FROMALTSTACK OP_FROMALTSTACK OP_FROMALTSTACK OP_FROMALTSTACK OP_ENDIF OP_OVER OP_9 OP_ROLL OP_NUMEQUAL OP_IF OP_5 OP_PICK OP_OVER OP_ADD OP_6 OP_ROLL OP_DROP OP_SWAP OP_TOALTSTACK OP_SWAP OP_TOALTSTACK OP_SWAP OP_TOALTSTACK OP_SWAP OP_TOALTSTACK OP_SWAP OP_FROMALTSTACK OP_FROMALTSTACK OP_FROMALTSTACK OP_FROMALTSTACK OP_ENDIF OP_SWAP OP_7 OP_ROLL OP_NUMEQUAL OP_IF OP_3 OP_PICK OP_OVER OP_ADD OP_4 OP_ROLL OP_DROP OP_SWAP OP_TOALTSTACK OP_SWAP OP_TOALTSTACK OP_SWAP OP_FROMALTSTACK OP_FROMALTSTACK OP_ENDIF OP_5 OP_PICK OP_5 OP_PICK OP_ADD OP_4 OP_PICK OP_ADD OP_DUP OP_9 OP_PICK OP_GREATERTHANOREQUAL OP_VERIFY OP_6 OP_PICK 64 OP_MUL OP_SWAP OP_DIV OP_9 OP_ROLL OP_GREATERTHANOREQUAL OP_VERIFY OP_1 OP_1 OP_CAT OP_7 OP_ROLL OP_4 OP_SPLIT OP_DROP OP_CAT OP_6 OP_ROLL OP_4 OP_NUM2BIN OP_CAT OP_5 OP_ROLL OP_4 OP_NUM2BIN OP_CAT OP_4 OP_ROLL OP_4 OP_NUM2BIN OP_CAT OP_4 OP_ROLL OP_4 OP_NUM2BIN OP_CAT OP_TXLOCKTIME OP_5 OP_NUM2BIN OP_CAT 0000000000000000000000000000000000000000000000000000 OP_CAT OP_0 OP_OUTPUTTOKENCOMMITMENT OP_EQUALVERIFY OP_0 OP_OUTPUTBYTECODE OP_0 OP_UTXOBYTECODE OP_EQUAL OP_NIP OP_NIP OP_NIP",
  "source": "/**\n * TallyCommitment_FixedMax — Trustless on-chain tally for up to 3 voters\n *\n * ENFORCEABILITY: [ENFORCEABLE-NOW]\n *\n * PURPOSE: Aggregate votes into executable tally proof (pre-Layla, max 3 voters).\n * - Validate each VoteNFT links to this proposal\n * - Tally token amounts by vote choice (FOR / AGAINST / ABSTAIN)\n * - Check quorum and majority thresholds on-chain\n * - Commit result for proposal execution gating\n *\n * NFT COMMITMENT (40 bytes — within CashTokens 40-byte limit):\n *   [0]:     version (uint8) = 1\n *   [1]:     status (uint8: 0=OPEN, 1=FINALIZED)\n *   [2-5]:   proposal_id_prefix (4 bytes)\n *   [6-9]:   votes_for (uint32)\n *   [10-13]: votes_against (uint32)\n *   [14-17]: votes_abstain (uint32)\n *   [18-21]: quorum_threshold (uint32)\n *   [22-26]: tally_timestamp (5 bytes, unix seconds)\n *   [27-39]: reserved\n *\n * PRE-LAYLA LIMITS: Hardcoded for 3 voters\n * POST-LAYLA: Loops CHIP enables arbitrary voter count\n */\n\npragma cashscript ^0.13.0;\n\ncontract TallyCommitment_FixedMax(\n    bytes32 proposalId,\n    int quorumThreshold,\n    int majorityThreshold\n) {\n    /**\n     * createTally() — Aggregate 3 votes and commit tally result\n     *\n     * Inputs 0..2 must each be a VoteNFT for this proposal.\n     * Output[0] is the TallyNFT with the finalized result.\n     */\n    function createTally() {\n        int VOTE_AGAINST = 0;\n        int VOTE_FOR     = 1;\n        int VOTE_ABSTAIN = 2;\n\n        int totalFor     = 0;\n        int totalAgainst = 0;\n        int totalAbstain = 0;\n\n        bytes v0 = tx.inputs[0].nftCommitment;\n        require(v0.split(1)[1].split(4)[0] == proposalId.split(4)[0]);\n        int choice0 = int(v0.split(5)[1].split(1)[0]);\n        int amount0 = tx.inputs[0].tokenAmount;\n        if (choice0 == VOTE_FOR)     { totalFor = totalFor + amount0; }\n        if (choice0 == VOTE_AGAINST) { totalAgainst = totalAgainst + amount0; }\n        if (choice0 == VOTE_ABSTAIN) { totalAbstain = totalAbstain + amount0; }\n\n        bytes v1 = tx.inputs[1].nftCommitment;\n        require(v1.split(1)[1].split(4)[0] == proposalId.split(4)[0]);\n        int choice1 = int(v1.split(5)[1].split(1)[0]);\n        int amount1 = tx.inputs[1].tokenAmount;\n        if (choice1 == VOTE_FOR)     { totalFor = totalFor + amount1; }\n        if (choice1 == VOTE_AGAINST) { totalAgainst = totalAgainst + amount1; }\n        if (choice1 == VOTE_ABSTAIN) { totalAbstain = totalAbstain + amount1; }\n\n        bytes v2 = tx.inputs[2].nftCommitment;\n        require(v2.split(1)[1].split(4)[0] == proposalId.split(4)[0]);\n        int choice2 = int(v2.split(5)[1].split(1)[0]);\n        int amount2 = tx.inputs[2].tokenAmount;\n        if (choice2 == VOTE_FOR)     { totalFor = totalFor + amount2; }\n        if (choice2 == VOTE_AGAINST) { totalAgainst = totalAgainst + amount2; }\n        if (choice2 == VOTE_ABSTAIN) { totalAbstain = totalAbstain + amount2; }\n\n        int totalVotes = totalFor + totalAgainst + totalAbstain;\n        require(totalVotes >= quorumThreshold);\n        require((totalFor * 100) / totalVotes >= majorityThreshold);\n\n        bytes tallyCommitment =\n            0x01 +\n            0x01 +\n            proposalId.split(4)[0] +\n            toPaddedBytes(totalFor, 4) +\n            toPaddedBytes(totalAgainst, 4) +\n            toPaddedBytes(totalAbstain, 4) +\n            toPaddedBytes(quorumThreshold, 4) +\n            toPaddedBytes(tx.locktime, 5) +\n            0x0000000000000000000000000000000000000000000000000000;\n\n        require(tx.outputs[0].nftCommitment == tallyCommitment);\n        require(tx.outputs[0].lockingBytecode == tx.inputs[0].lockingBytecode);\n    }\n}\n",
  "debug": {
    "bytecode": "00515200000000cf76517f77547f755879547f7588557f77517f758100d07857799c6354797893557a757c6b7c6b7c6b7c6c6c6c687858799c6353797893547a757c6b7c6b7c6c6c687c55799c636e937b757c6851cf76517f77547f755979547f7588557f77517f758151d07858799c6355797893567a757c6b7c6b7c6b7c6b7c6c6c6c6c687859799c6354797893557a757c6b7c6b7c6b7c6c6c6c687c56799c6352797893537a757c6b7c6c6852cf76517f77547f755a79547f7588557f77517f758152d078597a9c6356797893577a757c6b7c6b7c6b7c6b7c6b7c6c6c6c6c6c6878597a9c6355797893567a757c6b7c6b7c6b7c6b7c6c6c6c6c687c577a9c6353797893547a757c6b7c6b7c6c6c685579557993547993765979a26956790164957c96597aa26951517e577a547f757e567a54807e557a54807e547a54807e547a54807ec555807e1a00000000000000000000000000000000000000000000000000007e00d28800cd00c787777777",
    "sourceMap": "41:27:41:28;42::42;43::43;45::45;46::46;47::47;49:29:49:30;:19::45:1;50:16:50:18:0;:25::26;:16::27:1;:::30;:37::38:0;:16::39:1;:::42;:46::56:0;;:63::64;:46::65:1;:::68;:8::70;51:35:51:36:0;:26::37:1;:::40;:47::48:0;:26::49:1;:::52;:22::53;52:32:52:33:0;:22::46:1;53:12:53:19:0;:23::31;;:12:::1;:37::71:0;:50::58;;:61::68;:50:::1;:39::69;;;;;;;;;;;;;:37::71;54:12:54:19:0;:23::35;;:12:::1;:37::79:0;:54::66;;:69::76;:54:::1;:39::77;;;;;;;;;;:37::79;55:12:55:19:0;:23::35;;:12:::1;:37::79:0;:54::76;::::1;:39::77;;;:37::79;57:29:57:30:0;:19::45:1;58:16:58:18:0;:25::26;:16::27:1;:::30;:37::38:0;:16::39:1;:::42;:46::56:0;;:63::64;:46::65:1;:::68;:8::70;59:35:59:36:0;:26::37:1;:::40;:47::48:0;:26::49:1;:::52;:22::53;60:32:60:33:0;:22::46:1;61:12:61:19:0;:23::31;;:12:::1;:37::71:0;:50::58;;:61::68;:50:::1;:39::69;;;;;;;;;;;;;;;;:37::71;62:12:62:19:0;:23::35;;:12:::1;:37::79:0;:54::66;;:69::76;:54:::1;:39::77;;;;;;;;;;;;;:37::79;63:12:63:19:0;:23::35;;:12:::1;:37::79:0;:54::66;;:69::76;:54:::1;:39::77;;;;;;;:37::79;65:29:65:30:0;:19::45:1;66:16:66:18:0;:25::26;:16::27:1;:::30;:37::38:0;:16::39:1;:::42;:46::56:0;;:63::64;:46::65:1;:::68;:8::70;67:35:67:36:0;:26::37:1;:::40;:47::48:0;:26::49:1;:::52;:22::53;68:32:68:33:0;:22::46:1;69:12:69:19:0;:23::31;;:12:::1;:37::71:0;:50::58;;:61::68;:50:::1;:39::69;;;;;;;;;;;;;;;;;;;:37::71;70:12:70:19:0;:23::35;;:12:::1;:37::79:0;:54::66;;:69::76;:54:::1;:39::77;;;;;;;;;;;;;;;;:37::79;71:12:71:19:0;:23::35;;:12:::1;:37::79:0;:54::66;;:69::76;:54:::1;:39::77;;;;;;;;;;:37::79;73:25:73:33:0;;:36::48;;:25:::1;:51::63:0;;:25:::1;74:16:74:26:0;:30::45;;:16:::1;:8::47;75:17:75:25:0;;:28::31;:17:::1;:35::45:0;:16:::1;:49::66:0;;:16:::1;:8::68;78:12:78:16:0;79::79;78::::1;80::80:22:0;;:29::30;:12::31:1;:::34;78;81:26:81::0;;:36::37;:12::38:1;78;82:26:82::0;;:40::41;:12::42:1;78;83:26:83:38:0;;:40::41;:12::42:1;78;84:26:84:41:0;;:43::44;:12::45:1;78;85:26:85:37:0;:39::40;:12::41:1;78;86::86:66:0;78::::1;88:27:88:28:0;:16::43:1;:8::64;89:27:89:28:0;:16::45:1;:59::60:0;:49::77:1;:8::79;40:4:90:5;;",
    "logs": [],
    "requires": [
      {
        "ip": 23,
        "line": 50
      },
      {
        "ip": 101,
        "line": 58
      },
      {
        "ip": 191,
        "line": 66
      },
      {
        "ip": 288,
        "line": 74
      },
      {
        "ip": 298,
        "line": 75
      },
      {
        "ip": 336,
        "line": 88
      },
      {
        "ip": 342,
        "line": 89
      }
    ]
  },
  "compiler": {
    "name": "cashc",
    "version": "0.13.0-next.3"
  },
  "updatedAt": "2026-02-26T11:10:59.904Z"
}
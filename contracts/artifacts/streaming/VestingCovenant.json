{
  "contractName": "VestingCovenant",
  "constructorInputs": [
    {
      "name": "vaultId",
      "type": "bytes32"
    },
    {
      "name": "senderHash",
      "type": "bytes20"
    },
    {
      "name": "scheduleType",
      "type": "int"
    },
    {
      "name": "totalAmount",
      "type": "int"
    },
    {
      "name": "startTimestamp",
      "type": "int"
    },
    {
      "name": "endTimestamp",
      "type": "int"
    },
    {
      "name": "cliffTimestamp",
      "type": "int"
    },
    {
      "name": "stepInterval",
      "type": "int"
    },
    {
      "name": "stepAmount",
      "type": "int"
    }
  ],
  "abi": [
    {
      "name": "claim",
      "inputs": [
        {
          "name": "recipientSig",
          "type": "sig"
        },
        {
          "name": "recipientPubkey",
          "type": "pubkey"
        }
      ]
    },
    {
      "name": "complete",
      "inputs": []
    },
    {
      "name": "pause",
      "inputs": [
        {
          "name": "senderSig",
          "type": "sig"
        },
        {
          "name": "senderPubkey",
          "type": "pubkey"
        }
      ]
    },
    {
      "name": "resume",
      "inputs": [
        {
          "name": "senderSig",
          "type": "sig"
        },
        {
          "name": "senderPubkey",
          "type": "pubkey"
        }
      ]
    },
    {
      "name": "cancel",
      "inputs": [
        {
          "name": "senderSig",
          "type": "sig"
        },
        {
          "name": "senderPubkey",
          "type": "pubkey"
        }
      ]
    },
    {
      "name": "transfer",
      "inputs": [
        {
          "name": "recipientSig",
          "type": "sig"
        },
        {
          "name": "recipientPubkey",
          "type": "pubkey"
        },
        {
          "name": "newRecipientHash",
          "type": "bytes20"
        }
      ]
    }
  ],
  "bytecode": "OP_9 OP_PICK OP_0 OP_NUMEQUAL OP_IF OP_0 OP_UTXOTOKENCOMMITMENT OP_DUP OP_1 OP_SPLIT OP_DROP OP_BIN2NUM OP_OVER OP_1 OP_SPLIT OP_NIP OP_1 OP_SPLIT OP_DROP OP_2 OP_PICK OP_2 OP_SPLIT OP_NIP OP_8 OP_SPLIT OP_DROP OP_BIN2NUM OP_3 OP_PICK OP_10 OP_SPLIT OP_NIP OP_5 OP_SPLIT OP_DROP OP_BIN2NUM OP_4 OP_ROLL 14 OP_SPLIT OP_NIP 14 OP_SPLIT OP_DROP OP_16 OP_PICK OP_HASH160 OP_OVER OP_EQUALVERIFY OP_15 OP_ROLL OP_16 OP_ROLL OP_CHECKSIGVERIFY OP_4 OP_ROLL OP_0 OP_NUMEQUALVERIFY OP_10 OP_PICK OP_0 OP_GREATERTHAN OP_IF OP_TXLOCKTIME OP_11 OP_PICK OP_GREATERTHANOREQUAL OP_VERIFY OP_ENDIF OP_TXLOCKTIME OP_2 OP_PICK OP_SUB OP_10 OP_ROLL OP_10 OP_ROLL OP_SUB OP_0 OP_9 OP_PICK OP_1 OP_NUMEQUAL OP_IF OP_2 OP_PICK OP_2 OP_PICK OP_GREATERTHANOREQUAL OP_IF OP_10 OP_PICK OP_NIP OP_ELSE OP_10 OP_PICK OP_3 OP_PICK OP_MUL OP_2 OP_PICK OP_DIV OP_NIP OP_ENDIF OP_ENDIF OP_9 OP_ROLL OP_2 OP_NUMEQUAL OP_IF OP_2 OP_PICK OP_12 OP_PICK OP_DIV OP_DUP OP_14 OP_PICK OP_MUL OP_ROT OP_DROP OP_SWAP OP_OVER OP_11 OP_PICK OP_GREATERTHAN OP_IF OP_10 OP_PICK OP_ROT OP_DROP OP_SWAP OP_ENDIF OP_DROP OP_ENDIF OP_5 OP_PICK OP_SUB OP_DUP OP_0 OP_GREATERTHAN OP_VERIFY OP_0 OP_OUTPUTBYTECODE 76a914 OP_5 OP_PICK OP_CAT 88ac OP_CAT OP_EQUALVERIFY OP_6 OP_PICK OP_4 OP_AND OP_4 OP_EQUAL OP_IF OP_0 OP_OUTPUTTOKENCATEGORY OP_0 OP_UTXOTOKENCATEGORY OP_EQUALVERIFY OP_0 OP_OUTPUTTOKENAMOUNT OP_OVER OP_NUMEQUALVERIFY OP_ELSE OP_0 OP_OUTPUTVALUE OP_OVER OP_NUMEQUALVERIFY OP_ENDIF OP_5 OP_ROLL OP_ADD OP_0 OP_OVER OP_10 OP_ROLL OP_GREATERTHANOREQUAL OP_IF OP_DROP OP_3 OP_ENDIF OP_1 OP_NUM2BIN OP_6 OP_ROLL OP_CAT OP_SWAP OP_8 OP_NUM2BIN OP_CAT OP_4 OP_ROLL OP_5 OP_NUM2BIN OP_CAT 0000000000 OP_CAT OP_3 OP_ROLL OP_CAT OP_1 OP_OUTPUTTOKENCOMMITMENT OP_EQUALVERIFY OP_1 OP_OUTPUTTOKENCATEGORY OP_0 OP_UTXOTOKENCATEGORY OP_EQUALVERIFY OP_1 OP_OUTPUTBYTECODE OP_0 OP_UTXOBYTECODE OP_EQUALVERIFY OP_2DROP OP_2DROP OP_2DROP OP_2DROP OP_1 OP_ELSE OP_9 OP_PICK OP_1 OP_NUMEQUAL OP_IF OP_0 OP_UTXOTOKENCOMMITMENT OP_DUP OP_1 OP_SPLIT OP_DROP OP_BIN2NUM OP_OVER OP_1 OP_SPLIT OP_NIP OP_1 OP_SPLIT OP_DROP OP_2 OP_PICK OP_2 OP_SPLIT OP_NIP OP_8 OP_SPLIT OP_DROP OP_BIN2NUM OP_3 OP_ROLL 14 OP_SPLIT OP_NIP 14 OP_SPLIT OP_DROP OP_3 OP_PICK OP_0 OP_NUMEQUAL OP_4 OP_ROLL OP_1 OP_NUMEQUAL OP_BOOLOR OP_VERIFY OP_TXLOCKTIME OP_9 OP_ROLL OP_GREATERTHANOREQUAL OP_VERIFY OP_6 OP_ROLL OP_ROT OP_SUB OP_DUP OP_0 OP_GREATERTHAN OP_IF OP_0 OP_OUTPUTBYTECODE 76a914 OP_3 OP_PICK OP_CAT 88ac OP_CAT OP_EQUALVERIFY OP_2 OP_PICK OP_4 OP_AND OP_4 OP_EQUAL OP_IF OP_0 OP_OUTPUTTOKENCATEGORY OP_0 OP_UTXOTOKENCATEGORY OP_EQUALVERIFY OP_0 OP_OUTPUTTOKENAMOUNT OP_OVER OP_NUMEQUALVERIFY OP_ELSE OP_0 OP_OUTPUTVALUE OP_OVER OP_NUMEQUALVERIFY OP_ENDIF OP_ENDIF OP_3 OP_ROLL 0000000000000000000000000000000000000000000000000000000000000000 OP_EQUAL OP_NOT OP_VERIFY OP_2DROP OP_2DROP OP_2DROP OP_2DROP OP_2DROP OP_1 OP_ELSE OP_9 OP_PICK OP_2 OP_NUMEQUAL OP_IF OP_0 OP_UTXOTOKENCOMMITMENT OP_DUP OP_1 OP_SPLIT OP_DROP OP_BIN2NUM OP_OVER OP_1 OP_SPLIT OP_NIP OP_1 OP_SPLIT OP_DROP OP_14 OP_PICK OP_HASH160 OP_5 OP_ROLL OP_EQUALVERIFY OP_12 OP_ROLL OP_13 OP_ROLL OP_CHECKSIGVERIFY OP_DUP OP_1 OP_AND OP_1 OP_EQUALVERIFY OP_SWAP OP_0 OP_NUMEQUALVERIFY OP_1 OP_SWAP OP_CAT OP_OVER OP_2 OP_SPLIT OP_NIP OP_8 OP_SPLIT OP_DROP OP_CAT OP_OVER OP_10 OP_SPLIT OP_NIP OP_5 OP_SPLIT OP_DROP OP_CAT OP_TXLOCKTIME OP_5 OP_NUM2BIN OP_CAT OP_SWAP 14 OP_SPLIT OP_NIP 14 OP_SPLIT OP_DROP OP_CAT OP_0 OP_OUTPUTTOKENCOMMITMENT OP_EQUALVERIFY OP_0 OP_OUTPUTTOKENCATEGORY OP_0 OP_UTXOTOKENCATEGORY OP_EQUALVERIFY OP_0 OP_OUTPUTBYTECODE OP_0 OP_UTXOBYTECODE OP_EQUALVERIFY OP_2DROP OP_2DROP OP_2DROP OP_2DROP OP_DROP OP_1 OP_ELSE OP_9 OP_PICK OP_3 OP_NUMEQUAL OP_IF OP_0 OP_UTXOTOKENCOMMITMENT OP_DUP OP_1 OP_SPLIT OP_DROP OP_BIN2NUM OP_OVER OP_1 OP_SPLIT OP_NIP OP_1 OP_SPLIT OP_DROP OP_2 OP_PICK OP_10 OP_SPLIT OP_NIP OP_5 OP_SPLIT OP_DROP OP_BIN2NUM OP_3 OP_PICK OP_15 OP_SPLIT OP_NIP OP_5 OP_SPLIT OP_DROP OP_BIN2NUM OP_16 OP_PICK OP_HASH160 OP_7 OP_ROLL OP_EQUALVERIFY OP_14 OP_ROLL OP_15 OP_ROLL OP_CHECKSIGVERIFY OP_3 OP_ROLL OP_1 OP_NUMEQUALVERIFY OP_DUP OP_0 OP_GREATERTHAN OP_VERIFY OP_TXLOCKTIME OP_SWAP OP_SUB OP_ADD 00 OP_ROT OP_CAT OP_2 OP_PICK OP_2 OP_SPLIT OP_NIP OP_8 OP_SPLIT OP_DROP OP_CAT OP_SWAP OP_5 OP_NUM2BIN OP_CAT 0000000000 OP_CAT OP_SWAP 14 OP_SPLIT OP_NIP 14 OP_SPLIT OP_DROP OP_CAT OP_0 OP_OUTPUTTOKENCOMMITMENT OP_EQUALVERIFY OP_0 OP_OUTPUTTOKENCATEGORY OP_0 OP_UTXOTOKENCATEGORY OP_EQUALVERIFY OP_0 OP_OUTPUTBYTECODE OP_0 OP_UTXOBYTECODE OP_EQUALVERIFY OP_2DROP OP_2DROP OP_2DROP OP_2DROP OP_DROP OP_1 OP_ELSE OP_9 OP_PICK OP_4 OP_NUMEQUAL OP_IF OP_0 OP_UTXOTOKENCOMMITMENT OP_DUP OP_1 OP_SPLIT OP_DROP OP_BIN2NUM OP_OVER OP_1 OP_SPLIT OP_NIP OP_1 OP_SPLIT OP_DROP OP_2 OP_PICK OP_2 OP_SPLIT OP_NIP OP_8 OP_SPLIT OP_DROP OP_BIN2NUM OP_3 OP_PICK OP_10 OP_SPLIT OP_NIP OP_5 OP_SPLIT OP_DROP OP_BIN2NUM OP_4 OP_ROLL 14 OP_SPLIT OP_NIP 14 OP_SPLIT OP_DROP OP_16 OP_PICK OP_HASH160 OP_7 OP_PICK OP_EQUALVERIFY OP_15 OP_ROLL OP_16 OP_ROLL OP_CHECKSIGVERIFY OP_3 OP_PICK OP_1 OP_AND OP_1 OP_EQUALVERIFY OP_4 OP_PICK OP_0 OP_NUMEQUAL OP_5 OP_ROLL OP_1 OP_NUMEQUAL OP_BOOLOR OP_VERIFY OP_TXLOCKTIME OP_ROT OP_SUB OP_9 OP_ROLL OP_9 OP_ROLL OP_SUB OP_0 OP_8 OP_PICK OP_1 OP_NUMEQUAL OP_IF OP_2 OP_PICK OP_2 OP_PICK OP_GREATERTHANOREQUAL OP_IF OP_9 OP_PICK OP_NIP OP_ELSE OP_9 OP_PICK OP_3 OP_PICK OP_MUL OP_2 OP_PICK OP_DIV OP_NIP OP_ENDIF OP_ENDIF OP_8 OP_ROLL OP_2 OP_NUMEQUAL OP_IF OP_2 OP_PICK OP_11 OP_PICK OP_DIV OP_DUP OP_13 OP_PICK OP_MUL OP_ROT OP_DROP OP_SWAP OP_OVER OP_10 OP_PICK OP_GREATERTHAN OP_IF OP_9 OP_PICK OP_ROT OP_DROP OP_SWAP OP_ENDIF OP_DROP OP_ENDIF OP_DUP OP_5 OP_ROLL OP_SUB OP_8 OP_ROLL OP_ROT OP_SUB OP_OVER OP_0 OP_GREATERTHAN OP_IF OP_0 OP_OUTPUTBYTECODE 76a914 OP_6 OP_PICK OP_CAT 88ac OP_CAT OP_EQUALVERIFY OP_5 OP_PICK OP_4 OP_AND OP_4 OP_EQUAL OP_IF OP_0 OP_OUTPUTTOKENCATEGORY OP_0 OP_UTXOTOKENCATEGORY OP_EQUALVERIFY OP_0 OP_OUTPUTTOKENAMOUNT OP_2 OP_PICK OP_NUMEQUALVERIFY OP_ELSE OP_0 OP_OUTPUTVALUE OP_2 OP_PICK OP_NUMEQUALVERIFY OP_ENDIF OP_ENDIF OP_DUP OP_0 OP_GREATERTHAN OP_IF OP_1 OP_OUTPUTBYTECODE 76a914 OP_9 OP_PICK OP_CAT 88ac OP_CAT OP_EQUALVERIFY OP_5 OP_PICK OP_4 OP_AND OP_4 OP_EQUAL OP_IF OP_1 OP_OUTPUTTOKENCATEGORY OP_0 OP_UTXOTOKENCATEGORY OP_EQUALVERIFY OP_1 OP_OUTPUTTOKENAMOUNT OP_OVER OP_NUMEQUALVERIFY OP_ELSE OP_1 OP_OUTPUTVALUE OP_OVER OP_NUMEQUALVERIFY OP_ENDIF OP_ENDIF OP_2DROP OP_2DROP OP_2DROP OP_2DROP OP_2DROP OP_2DROP OP_1 OP_ELSE OP_9 OP_ROLL OP_5 OP_NUMEQUALVERIFY OP_0 OP_UTXOTOKENCOMMITMENT OP_DUP OP_1 OP_SPLIT OP_DROP OP_BIN2NUM OP_OVER OP_1 OP_SPLIT OP_NIP OP_1 OP_SPLIT OP_DROP OP_2 OP_PICK 14 OP_SPLIT OP_NIP 14 OP_SPLIT OP_DROP OP_14 OP_PICK OP_HASH160 OP_EQUALVERIFY OP_12 OP_ROLL OP_13 OP_ROLL OP_CHECKSIGVERIFY OP_2 OP_AND OP_2 OP_EQUALVERIFY OP_0 OP_NUMEQUALVERIFY 14 OP_SPLIT OP_DROP OP_10 OP_ROLL OP_CAT OP_0 OP_OUTPUTTOKENCOMMITMENT OP_EQUALVERIFY OP_0 OP_OUTPUTTOKENCATEGORY OP_0 OP_UTXOTOKENCATEGORY OP_EQUALVERIFY OP_0 OP_OUTPUTBYTECODE OP_0 OP_UTXOBYTECODE OP_EQUALVERIFY OP_2DROP OP_2DROP OP_2DROP OP_2DROP OP_DROP OP_1 OP_ENDIF OP_ENDIF OP_ENDIF OP_ENDIF OP_ENDIF",
  "source": "/**\n * VestingCovenant — Production Grade\n *\n * ENFORCEABILITY: [ENFORCEABLE-NOW]\n *\n * PURPOSE: Enforce token/BCH vesting schedules.\n *          Supports LINEAR_VESTING and STEP_VESTING with cliff.\n *          Recipient can claim vested amount at any time.\n *          Pause/resume shifts effective start forward by pause duration.\n *\n * NFT COMMITMENT (40 bytes — within CashTokens 40-byte limit):\n *   [0]:     status (uint8: 0=ACTIVE, 1=PAUSED, 2=CANCELLED, 3=COMPLETED)\n *   [1]:     flags (uint8: bit0=cancelable, bit1=transferable, bit2=usesTokens)\n *   [2-9]:   total_released (uint64)\n *   [10-14]: cursor (5 bytes, adjusted start for pause accounting)\n *   [15-19]: pause_start (5 bytes, when current pause began; 0 if not paused)\n *   [20-39]: recipient_hash (bytes20)\n *\n * CONTRACT PARAMETERS (compiled into bytecode, immutable):\n *   vaultId        — links schedule to source vault\n *   senderHash     — hash160(sender pubkey) (controls pause/cancel)\n *   scheduleType   — 1=LINEAR_VESTING, 2=STEP_VESTING\n *   totalAmount    — total tokens/BCH to vest\n *   startTimestamp — vesting start (may differ from cliff)\n *   endTimestamp   — when full vesting completes\n *   cliffTimestamp — no claims before this time (0 = no cliff)\n *   stepInterval   — seconds per step (for STEP_VESTING; 0 for LINEAR)\n *   stepAmount     — tokens per step (for STEP_VESTING; 0 for LINEAR)\n */\n\npragma cashscript ^0.13.0;\n\ncontract VestingCovenant(\n    bytes32 vaultId,\n    bytes20 senderHash,\n    int scheduleType,\n    int totalAmount,\n    int startTimestamp,\n    int endTimestamp,\n    int cliffTimestamp,\n    int stepInterval,\n    int stepAmount\n) {\n    /**\n     * claim() — Recipient claims vested tokens\n     *\n     * For LINEAR: vestedNow = totalAmount * elapsed / duration - alreadyReleased\n     * For STEP: vestedNow = completedSteps * stepAmount - alreadyReleased\n     * Cliff enforced: no claims before cliffTimestamp.\n     */\n    function claim(sig recipientSig, pubkey recipientPubkey) {\n        bytes c = tx.inputs[0].nftCommitment;\n        int status        = int(c.split(1)[0]);\n        bytes1 flagsByte  = c.split(1)[1].split(1)[0];\n        int totalReleased = int(c.split(2)[1].split(8)[0]);\n        int cursor        = int(c.split(10)[1].split(5)[0]);\n        bytes20 recipient = c.split(20)[1].split(20)[0];\n\n        require(hash160(recipientPubkey) == recipient);\n        require(checkSig(recipientSig, recipientPubkey));\n        require(status == 0); // ACTIVE\n\n        // Cliff enforcement\n        if (cliffTimestamp > 0) { require(tx.locktime >= cliffTimestamp); }\n\n        // Compute vested amount based on schedule type\n        int elapsed  = tx.locktime - cursor;\n        int duration = endTimestamp - startTimestamp;\n        int vestedTotal = 0;\n\n        if (scheduleType == 1) {\n            // LINEAR: proportional to elapsed time\n            if (elapsed >= duration) {\n                vestedTotal = totalAmount;\n            } else {\n                vestedTotal = (totalAmount * elapsed) / duration;\n            }\n        }\n\n        if (scheduleType == 2) {\n            // STEP: complete steps only\n            int completedSteps = elapsed / stepInterval;\n            vestedTotal = completedSteps * stepAmount;\n            if (vestedTotal > totalAmount) { vestedTotal = totalAmount; }\n        }\n\n        int claimable = vestedTotal - totalReleased;\n        require(claimable > 0);\n\n        require(tx.outputs[0].lockingBytecode == new LockingBytecodeP2PKH(recipient));\n\n        if ((flagsByte & 0x04) == 0x04) {\n            require(tx.outputs[0].tokenCategory == tx.inputs[0].tokenCategory);\n            require(tx.outputs[0].tokenAmount == claimable);\n        } else {\n            require(tx.outputs[0].value == claimable);\n        }\n\n        int newTotalReleased = totalReleased + claimable;\n        int newStatus = 0;\n        if (newTotalReleased >= totalAmount) { newStatus = 3; } // COMPLETED\n\n        bytes newCommitment =\n            toPaddedBytes(newStatus, 1) +\n            flagsByte +\n            toPaddedBytes(newTotalReleased, 8) +\n            toPaddedBytes(cursor, 5) +\n            0x0000000000 +\n            recipient;\n\n        require(tx.outputs[1].nftCommitment == newCommitment);\n        require(tx.outputs[1].tokenCategory == tx.inputs[0].tokenCategory);\n        require(tx.outputs[1].lockingBytecode == tx.inputs[0].lockingBytecode);\n    }\n\n    /**\n     * complete() — Force complete after end time (permissionless cleanup)\n     *\n     * Returns any unvested remainder to sender.\n     */\n    function complete() {\n        bytes c = tx.inputs[0].nftCommitment;\n        int status        = int(c.split(1)[0]);\n        bytes1 flagsByte  = c.split(1)[1].split(1)[0];\n        int totalReleased = int(c.split(2)[1].split(8)[0]);\n        bytes20 recipient = c.split(20)[1].split(20)[0];\n\n        require(status == 0 || status == 1); // ACTIVE or PAUSED\n        require(tx.locktime >= endTimestamp);\n\n        int remaining = totalAmount - totalReleased;\n\n        if (remaining > 0) {\n            // Any unclaimed vested portion goes to recipient\n            require(tx.outputs[0].lockingBytecode == new LockingBytecodeP2PKH(recipient));\n            if ((flagsByte & 0x04) == 0x04) {\n                require(tx.outputs[0].tokenCategory == tx.inputs[0].tokenCategory);\n                require(tx.outputs[0].tokenAmount == remaining);\n            } else {\n                require(tx.outputs[0].value == remaining);\n            }\n        }\n        require(vaultId != 0x0000000000000000000000000000000000000000000000000000000000000000);\n    }\n\n    /**\n     * pause() — Pause vesting (paused time does not vest)\n     *\n     * Sender-only. Requires cancelable flag.\n     * Records pause_start in state.\n     */\n    function pause(sig senderSig, pubkey senderPubkey) {\n        bytes c = tx.inputs[0].nftCommitment;\n        int status       = int(c.split(1)[0]);\n        bytes1 flagsByte = c.split(1)[1].split(1)[0];\n\n        require(hash160(senderPubkey) == senderHash);\n        require(checkSig(senderSig, senderPubkey));\n        require((flagsByte & 0x01) == 0x01);\n        require(status == 0); // ACTIVE\n\n        bytes newCommitment =\n            0x01 +\n            flagsByte +\n            c.split(2)[1].split(8)[0] +\n            c.split(10)[1].split(5)[0] +\n            toPaddedBytes(tx.locktime, 5) +\n            c.split(20)[1].split(20)[0];\n\n        require(tx.outputs[0].nftCommitment == newCommitment);\n        require(tx.outputs[0].tokenCategory == tx.inputs[0].tokenCategory);\n        require(tx.outputs[0].lockingBytecode == tx.inputs[0].lockingBytecode);\n    }\n\n    /**\n     * resume() — Resume vesting\n     *\n     * Sender-only. Advances cursor by pause duration so paused time doesn't vest.\n     */\n    function resume(sig senderSig, pubkey senderPubkey) {\n        bytes c = tx.inputs[0].nftCommitment;\n        int status      = int(c.split(1)[0]);\n        bytes1 flagsByte = c.split(1)[1].split(1)[0];\n        int cursor      = int(c.split(10)[1].split(5)[0]);\n        int pauseStart  = int(c.split(15)[1].split(5)[0]);\n\n        require(hash160(senderPubkey) == senderHash);\n        require(checkSig(senderSig, senderPubkey));\n        require(status == 1); // PAUSED\n        require(pauseStart > 0);\n\n        // Advance cursor by the pause duration\n        int pauseDuration = tx.locktime - pauseStart;\n        int newCursor = cursor + pauseDuration;\n\n        bytes newCommitment =\n            0x00 +\n            flagsByte +\n            c.split(2)[1].split(8)[0] +\n            toPaddedBytes(newCursor, 5) +\n            0x0000000000 +\n            c.split(20)[1].split(20)[0];\n\n        require(tx.outputs[0].nftCommitment == newCommitment);\n        require(tx.outputs[0].tokenCategory == tx.inputs[0].tokenCategory);\n        require(tx.outputs[0].lockingBytecode == tx.inputs[0].lockingBytecode);\n    }\n\n    /**\n     * cancel() — Cancel vesting and split vested/unvested\n     *\n     * Sender-only. Requires cancelable flag.\n     * Vested portion goes to recipient, unvested returns to sender.\n     */\n    function cancel(sig senderSig, pubkey senderPubkey) {\n        bytes c = tx.inputs[0].nftCommitment;\n        int status        = int(c.split(1)[0]);\n        bytes1 flagsByte  = c.split(1)[1].split(1)[0];\n        int totalReleased = int(c.split(2)[1].split(8)[0]);\n        int cursor        = int(c.split(10)[1].split(5)[0]);\n        bytes20 recipient = c.split(20)[1].split(20)[0];\n\n        require(hash160(senderPubkey) == senderHash);\n        require(checkSig(senderSig, senderPubkey));\n        require((flagsByte & 0x01) == 0x01);\n        require(status == 0 || status == 1);\n\n        // Compute vested at cancel time\n        int elapsed  = tx.locktime - cursor;\n        int duration = endTimestamp - startTimestamp;\n        int vestedAtCancel = 0;\n\n        if (scheduleType == 1) {\n            if (elapsed >= duration) {\n                vestedAtCancel = totalAmount;\n            } else {\n                vestedAtCancel = (totalAmount * elapsed) / duration;\n            }\n        }\n\n        if (scheduleType == 2) {\n            int completedSteps = elapsed / stepInterval;\n            vestedAtCancel = completedSteps * stepAmount;\n            if (vestedAtCancel > totalAmount) { vestedAtCancel = totalAmount; }\n        }\n\n        int claimableNow = vestedAtCancel - totalReleased;\n        int unvested = totalAmount - vestedAtCancel;\n\n        // Output[0]: claimable vested to recipient (if any)\n        if (claimableNow > 0) {\n            require(tx.outputs[0].lockingBytecode == new LockingBytecodeP2PKH(recipient));\n            if ((flagsByte & 0x04) == 0x04) {\n                require(tx.outputs[0].tokenCategory == tx.inputs[0].tokenCategory);\n                require(tx.outputs[0].tokenAmount == claimableNow);\n            } else {\n                require(tx.outputs[0].value == claimableNow);\n            }\n        }\n\n        // Output[1] (or [0] if no claimable): unvested back to sender\n        if (unvested > 0) {\n            require(tx.outputs[1].lockingBytecode == new LockingBytecodeP2PKH(senderHash));\n            if ((flagsByte & 0x04) == 0x04) {\n                require(tx.outputs[1].tokenCategory == tx.inputs[0].tokenCategory);\n                require(tx.outputs[1].tokenAmount == unvested);\n            } else {\n                require(tx.outputs[1].value == unvested);\n            }\n        }\n    }\n\n    /**\n     * transfer() — Recipient reassigns vesting to new address\n     *\n     * Requires FLAG_TRANSFERABLE. Current recipient must sign.\n     */\n    function transfer(sig recipientSig, pubkey recipientPubkey, bytes20 newRecipientHash) {\n        bytes c = tx.inputs[0].nftCommitment;\n        int status        = int(c.split(1)[0]);\n        bytes1 flagsByte  = c.split(1)[1].split(1)[0];\n        bytes20 current   = c.split(20)[1].split(20)[0];\n\n        require(hash160(recipientPubkey) == current);\n        require(checkSig(recipientSig, recipientPubkey));\n        require((flagsByte & 0x02) == 0x02); // transferable\n        require(status == 0); // ACTIVE\n\n        bytes newCommitment = c.split(20)[0] + newRecipientHash;\n        require(tx.outputs[0].nftCommitment == newCommitment);\n        require(tx.outputs[0].tokenCategory == tx.inputs[0].tokenCategory);\n        require(tx.outputs[0].lockingBytecode == tx.inputs[0].lockingBytecode);\n    }\n}\n",
  "debug": {
    "bytecode": "5979009c6300cf76517f758178517f77517f755279527f77587f758153795a7f77557f7581547a01147f7701147f756079a978885f7a607aad547a009d5a7900a063c55b79a26968c55279945a7a5a7a94005979519c6352795279a2635a7977675a79537995527996776868597a529c6352795c7996765e79957b757c785b79a0635a797b757c6875685579947600a06900cd0376a91455797e0288ac7e885679548454876300d100ce8800d3789d6700cc789d68557a9300785a7aa2637553685180567a7e7c58807e547a55807e0500000000007e537a7e51d28851d100ce8851cd00c7886d6d6d6d51675979519c6300cf76517f758178517f77517f755279527f77587f7581537a01147f7701147f755379009c547a519c9b69c5597aa269567a7b947600a06300cd0376a91453797e0288ac7e885279548454876300d100ce8800d3789d6700cc789d6868537a2000000000000000000000000000000000000000000000000000000000000000008791696d6d6d6d6d51675979529c6300cf76517f758178517f77517f755e79a9557a885c7a5d7aad76518451887c009d517c7e78527f77587f757e785a7f77557f757ec555807e7c01147f7701147f757e00d28800d100ce8800cd00c7886d6d6d6d7551675979539c6300cf76517f758178517f77517f7552795a7f77557f758153795f7f77557f75816079a9577a885e7a5f7aad537a519d7600a069c57c949301007b7e5279527f77587f757e7c55807e0500000000007e7c01147f7701147f757e00d28800d100ce8800cd00c7886d6d6d6d7551675979549c6300cf76517f758178517f77517f755279527f77587f758153795a7f77557f7581547a01147f7701147f756079a95779885f7a607aad5379518451885479009c557a519c9b69c57b94597a597a94005879519c6352795279a263597977675979537995527996776868587a529c6352795b7996765d79957b757c785a79a06359797b757c68756876557a94587a7b947800a06300cd0376a91456797e0288ac7e885579548454876300d100ce8800d352799d6700cc52799d68687600a06351cd0376a91459797e0288ac7e885579548454876351d100ce8851d3789d6751cc789d68686d6d6d6d6d6d5167597a559d00cf76517f758178517f77517f75527901147f7701147f755e79a9885c7a5d7aad52845288009d01147f755a7a7e00d28800d100ce8800cd00c7886d6d6d6d75516868686868",
    "sourceMap": "51:4:114:5;;;;;52:28:52:29;:18::44:1;53:32:53:33:0;:40::41;:32::42:1;:::45;:28::46;54::54:29:0;:36::37;:28::38:1;:::41;:48::49:0;:28::50:1;:::53;55:32:55:33:0;;:40::41;:32::42:1;:::45;:52::53:0;:32::54:1;:::57;:28::58;56:32:56:33:0;;:40::42;:32::43:1;:::46;:53::54:0;:32::55:1;:::58;:28::59;57::57:29:0;;:36::38;:28::39:1;:::42;:49::51:0;:28::52:1;:::55;59:24:59:39:0;;:16::40:1;:44::53:0;:8::55:1;60:25:60:37:0;;:39::54;;:8::57:1;61:16:61:22:0;;:26::27;:8::29:1;64:12:64:26:0;;:29::30;:12:::1;:32::75:0;:42::53;:57::71;;:42:::1;:34::73;:32::75;67:23:67:34:0;:37::43;;:23:::1;68::68:35:0;;:38::52;;:23:::1;69:26:69:27:0;71:12:71:24;;:28::29;:12:::1;:31:78:9:0;73:16:73:23;;:27::35;;:16:::1;:37:75:13:0;74:30:74:41;;:16::42:1;75:19:77:13:0;76:31:76:42;;:45::52;;:31:::1;:56::64:0;;:30:::1;:16::65;75:19:77:13;71:31:78:9;80:12:80:24:0;;:28::29;:12:::1;:31:85:9:0;82:33:82:40;;:43::55;;:33:::1;83:26:83:40:0;:43::53;;:26:::1;:12::54;;;84:16:84:27:0;:30::41;;:16:::1;:43::73:0;:59::70;;:45::71:1;;;:43::73;80:31:85:9;;87:38:87:51:0;;:24:::1;88:16:88:25:0;:28::29;:16:::1;:8::31;90:27:90:28:0;:16::45:1;:49::84:0;:74::83;;:49::84:1;;;:8::86;92:13:92:22:0;;:25::29;:13:::1;:34::38:0;:12:::1;:40:95:9:0;93:31:93:32;:20::47:1;:61::62:0;:51::77:1;:12::79;94:31:94:32:0;:20::45:1;:49::58:0;:12::60:1;95:15:97:9:0;96:31:96:32;:20::39:1;:43::52:0;:12::54:1;95:15:97:9;99:31:99:44:0;;:::56:1;100:24:100:25:0;101:12:101:28;:32::43;;:12:::1;:45::63:0;:47::61:1;;:45::63;104:37:104:38:0;:12::39:1;105::105:21:0;;104::::1;106:26:106:42:0;:44::45;:12::46:1;104;107:26:107:32:0;;:34::35;:12::36:1;104;108::108:24:0;104::::1;109::109:21:0;;104::::1;111:27:111:28:0;:16::43:1;:8::62;112:27:112:28:0;:16::43:1;:57::58:0;:47::73:1;:8::75;113:27:113:28:0;:16::45:1;:59::60:0;:49::77:1;:8::79;51:4:114:5;;;;;;121::144::0;;;;;122:28:122:29;:18::44:1;123:32:123:33:0;:40::41;:32::42:1;:::45;:28::46;124::124:29:0;:36::37;:28::38:1;:::41;:48::49:0;:28::50:1;:::53;125:32:125:33:0;;:40::41;:32::42:1;:::45;:52::53:0;:32::54:1;:::57;:28::58;126::126:29:0;;:36::38;:28::39:1;:::42;:49::51:0;:28::52:1;:::55;128:16:128:22:0;;:26::27;:16:::1;:31::37:0;;:41::42;:31:::1;:16;:8::44;129:16:129:27:0;:31::43;;:16:::1;:8::45;131:24:131:35:0;;:38::51;:24:::1;133:12:133:21:0;:24::25;:12:::1;:27:142:9:0;135:31:135:32;:20::49:1;:53::88:0;:78::87;;:53::88:1;;;:12::90;136:17:136:26:0;;:29::33;:17:::1;:38::42:0;:16:::1;:44:139:13:0;137:35:137:36;:24::51:1;:65::66:0;:55::81:1;:16::83;138:35:138:36:0;:24::49:1;:53::62:0;:16::64:1;139:19:141:13:0;140:35:140:36;:24::43:1;:47::56:0;:16::58:1;139:19:141:13;133:27:142:9;143:16:143:23:0;;:27::93;:16:::1;;:8::95;121:4:144:5;;;;;;;152::173::0;;;;;153:28:153:29;:18::44:1;154:31:154:32:0;:39::40;:31::41:1;:::44;:27::45;155::155:28:0;:35::36;:27::37:1;:::40;:47::48:0;:27::49:1;:::52;157:24:157:36:0;;:16::37:1;:41::51:0;;:8::53:1;158:25:158:34:0;;:36::48;;:8::51:1;159:17:159:26:0;:29::33;:17:::1;:38::42:0;:8::44:1;160:16:160:22:0;:26::27;:8::29:1;163:12:163:16:0;164::164:21;163::::1;165::165:13:0;:20::21;:12::22:1;:::25;:32::33:0;:12::34:1;:::37;163;166::166:13:0;:20::22;:12::23:1;:::26;:33::34:0;:12::35:1;:::38;163;167:26:167:37:0;:39::40;:12::41:1;163;168::168:13:0;:20::22;:12::23:1;:::26;:33::35:0;:12::36:1;:::39;163;170:27:170:28:0;:16::43:1;:8::62;171:27:171:28:0;:16::43:1;:57::58:0;:47::73:1;:8::75;172:27:172:28:0;:16::45:1;:59::60:0;:49::77:1;:8::79;152:4:173:5;;;;;;;180::207::0;;;;;181:28:181:29;:18::44:1;182:30:182:31:0;:38::39;:30::40:1;:::43;:26::44;183:27:183:28:0;:35::36;:27::37:1;:::40;:47::48:0;:27::49:1;:::52;184:30:184:31:0;;:38::40;:30::41:1;:::44;:51::52:0;:30::53:1;:::56;:26::57;185:30:185:31:0;;:38::40;:30::41:1;:::44;:51::52:0;:30::53:1;:::56;:26::57;187:24:187:36:0;;:16::37:1;:41::51:0;;:8::53:1;188:25:188:34:0;;:36::48;;:8::51:1;189:16:189:22:0;;:26::27;:8::29:1;190:16:190:26:0;:29::30;:16:::1;:8::32;193:28:193:39:0;:42::52;:28:::1;194:24:194:46;197:12:197:16:0;198::198:21;197::::1;199::199:13:0;;:20::21;:12::22:1;:::25;:32::33:0;:12::34:1;:::37;197;200:26:200:35:0;:37::38;:12::39:1;197;201::201:24:0;197::::1;202::202:13:0;:20::22;:12::23:1;:::26;:33::35:0;:12::36:1;:::39;197;204:27:204:28:0;:16::43:1;:8::62;205:27:205:28:0;:16::43:1;:57::58:0;:47::73:1;:8::75;206:27:206:28:0;:16::45:1;:59::60:0;:49::77:1;:8::79;180:4:207:5;;;;;;;215::271::0;;;;;216:28:216:29;:18::44:1;217:32:217:33:0;:40::41;:32::42:1;:::45;:28::46;218::218:29:0;:36::37;:28::38:1;:::41;:48::49:0;:28::50:1;:::53;219:32:219:33:0;;:40::41;:32::42:1;:::45;:52::53:0;:32::54:1;:::57;:28::58;220:32:220:33:0;;:40::42;:32::43:1;:::46;:53::54:0;:32::55:1;:::58;:28::59;221::221:29:0;;:36::38;:28::39:1;:::42;:49::51:0;:28::52:1;:::55;223:24:223:36:0;;:16::37:1;:41::51:0;;:8::53:1;224:25:224:34:0;;:36::48;;:8::51:1;225:17:225:26:0;;:29::33;:17:::1;:38::42:0;:8::44:1;226:16:226:22:0;;:26::27;:16:::1;:31::37:0;;:41::42;:31:::1;:16;:8::44;229:23:229:34:0;:37::43;:23:::1;230::230:35:0;;:38::52;;:23:::1;231:29:231:30:0;233:12:233:24;;:28::29;:12:::1;:31:239:9:0;234:16:234:23;;:27::35;;:16:::1;:37:236:13:0;235:33:235:44;;:16::45:1;236:19:238:13:0;237:34:237:45;;:48::55;;:34:::1;:59::67:0;;:33:::1;:16::68;236:19:238:13;233:31:239:9;241:12:241:24:0;;:28::29;:12:::1;:31:245:9:0;242:33:242:40;;:43::55;;:33:::1;243:29:243:43:0;:46::56;;:29:::1;:12::57;;;244:16:244:30:0;:33::44;;:16:::1;:46::79:0;:65::76;;:48::77:1;;;:46::79;241:31:245:9;;247:27:247:41:0;:44::57;;:27:::1;248:23:248:34:0;;:37::51;:23:::1;251:12:251:24:0;:27::28;:12:::1;:30:259:9:0;252:31:252:32;:20::49:1;:53::88:0;:78::87;;:53::88:1;;;:12::90;253:17:253:26:0;;:29::33;:17:::1;:38::42:0;:16:::1;:44:256:13:0;254:35:254:36;:24::51:1;:65::66:0;:55::81:1;:16::83;255:35:255:36:0;:24::49:1;:53::65:0;;:16::67:1;256:19:258:13:0;257:35:257:36;:24::43:1;:47::59:0;;:16::61:1;256:19:258:13;251:30:259:9;262:12:262:20:0;:23::24;:12:::1;:26:270:9:0;263:31:263:32;:20::49:1;:53::89:0;:78::88;;:53::89:1;;;:12::91;264:17:264:26:0;;:29::33;:17:::1;:38::42:0;:16:::1;:44:267:13:0;265:35:265:36;:24::51:1;:65::66:0;:55::81:1;:16::83;266:35:266:36:0;:24::49:1;:53::61:0;:16::63:1;267:19:269:13:0;268:35:268:36;:24::43:1;:47::55:0;:16::57:1;267:19:269:13;262:26:270:9;215:4:271:5;;;;;;;;278::293::0;;;;279:28:279:29;:18::44:1;280:32:280:33:0;:40::41;:32::42:1;:::45;:28::46;281::281:29:0;:36::37;:28::38:1;:::41;:48::49:0;:28::50:1;:::53;282::282:29:0;;:36::38;:28::39:1;:::42;:49::51:0;:28::52:1;:::55;284:24:284:39:0;;:16::40:1;:8::53;285:25:285:37:0;;:39::54;;:8::57:1;286:29:286:33:0;:17:::1;:38::42:0;:8::44:1;287:26:287:27:0;:8::29:1;289:38:289:40:0;:30::41:1;:::44;:47::63:0;;:30:::1;290:27:290:28:0;:16::43:1;:8::62;291:27:291:28:0;:16::43:1;:57::58:0;:47::73:1;:8::75;292:27:292:28:0;:16::45:1;:59::60:0;:49::77:1;:8::79;278:4:293:5;;;;;;33:0:294:1;;;;",
    "logs": [],
    "requires": [
      {
        "ip": 58,
        "line": 59
      },
      {
        "ip": 63,
        "line": 60
      },
      {
        "ip": 67,
        "line": 61
      },
      {
        "ip": 77,
        "line": 64
      },
      {
        "ip": 151,
        "line": 88
      },
      {
        "ip": 160,
        "line": 90
      },
      {
        "ip": 172,
        "line": 93
      },
      {
        "ip": 176,
        "line": 94
      },
      {
        "ip": 181,
        "line": 96
      },
      {
        "ip": 216,
        "line": 111
      },
      {
        "ip": 221,
        "line": 112
      },
      {
        "ip": 226,
        "line": 113
      },
      {
        "ip": 278,
        "line": 128
      },
      {
        "ip": 283,
        "line": 129
      },
      {
        "ip": 300,
        "line": 135
      },
      {
        "ip": 312,
        "line": 137
      },
      {
        "ip": 316,
        "line": 138
      },
      {
        "ip": 321,
        "line": 140
      },
      {
        "ip": 329,
        "line": 143
      },
      {
        "ip": 361,
        "line": 157
      },
      {
        "ip": 366,
        "line": 158
      },
      {
        "ip": 371,
        "line": 159
      },
      {
        "ip": 374,
        "line": 160
      },
      {
        "ip": 408,
        "line": 170
      },
      {
        "ip": 413,
        "line": 171
      },
      {
        "ip": 418,
        "line": 172
      },
      {
        "ip": 468,
        "line": 187
      },
      {
        "ip": 473,
        "line": 188
      },
      {
        "ip": 477,
        "line": 189
      },
      {
        "ip": 481,
        "line": 190
      },
      {
        "ip": 514,
        "line": 204
      },
      {
        "ip": 519,
        "line": 205
      },
      {
        "ip": 524,
        "line": 206
      },
      {
        "ip": 582,
        "line": 223
      },
      {
        "ip": 587,
        "line": 224
      },
      {
        "ip": 593,
        "line": 225
      },
      {
        "ip": 603,
        "line": 226
      },
      {
        "ip": 689,
        "line": 252
      },
      {
        "ip": 701,
        "line": 254
      },
      {
        "ip": 706,
        "line": 255
      },
      {
        "ip": 712,
        "line": 257
      },
      {
        "ip": 727,
        "line": 263
      },
      {
        "ip": 739,
        "line": 265
      },
      {
        "ip": 743,
        "line": 266
      },
      {
        "ip": 748,
        "line": 268
      },
      {
        "ip": 788,
        "line": 284
      },
      {
        "ip": 793,
        "line": 285
      },
      {
        "ip": 797,
        "line": 286
      },
      {
        "ip": 799,
        "line": 287
      },
      {
        "ip": 808,
        "line": 290
      },
      {
        "ip": 813,
        "line": 291
      },
      {
        "ip": 818,
        "line": 292
      }
    ]
  },
  "compiler": {
    "name": "cashc",
    "version": "0.13.0-next.3"
  },
  "updatedAt": "2026-02-26T11:10:49.947Z"
}